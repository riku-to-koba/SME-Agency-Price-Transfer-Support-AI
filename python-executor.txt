/**
 * Python コード実行ツール
 *
 * 機能:
 * - Python コードの実行(ローカル環境のすべてのライブラリが使用可能)
 * - UTF-8 エンコーディングによる日本語・英語・中国語対応
 *
 * 設計思想:
 * - シンプルで汎用的な実装
 * - 特定ライブラリに依存しない
 * - エンコーディング問題を完全に解決
 */

import { spawn } from 'child_process';
import { writeFile, unlink, readFile } from 'fs/promises';
import { join } from 'path';
import { tmpdir } from 'os';

export const pythonExecutor = {
  name: 'execute_python',

  description: `Pythonコードを実行します。ローカル環境にインストールされているすべてのライブラリ(numpy, pandas, matplotlib等)が使用できます。

使用例:
- データ計算・分析
- グラフ・可視化の生成
- ファイル処理
- 科学計算

重要な注意事項:
1. 結果を表示するには必ず print() を使用してください
   例: print(result), print(df.head()), print(array)
   ※ 式だけを書いても出力されません(Jupyter以外では print が必須)

2. 各実行は独立したプロセスです
   前回の実行で作成した変数は次の実行では存在しません
   データ作成から分析まで1つのコードにまとめてください

3. エラー時は必ず error フィールドを確認してください
   success=false の場合、error に完全な Traceback が含まれています
   ユーザーにエラー内容を正確に伝えてください

4. matplotlib グラフ作成時の禁止事項(自動処理されるため):
   ✗ plt.rcParams['font.family'] = ... を設定しないでください(自動設定済)
   ✗ plt.savefig() を呼ばないでください(自動保存されます)
   ✗ plt.show() を呼ばないでください(自動表示されます)
   ✗ plt.close() を呼ばないでください(自動クリーンアップされます)
   ✗ Base64 エンコードしないでください(自動で返されます)
   → グラフを作成したら、そのままにしておいてください

自動機能:
- matplotlib/seaborn のグラフは自動的に GUI ウィンドウで表示されます
- グラフは自動的に保存され Base64 で返されます
- 日本語・英語・中国語の完全対応(UTF-8 + 日本語フォント自動設定)
- タイムアウト設定でハング防止`,

  parameters: {
    type: 'object',
    properties: {
      code: {
        type: 'string',
        description: '実行する Python コード。インストール済みのライブラリは自由に使用可能。'
      },
      timeout: {
        type: 'number',
        description: 'タイムアウト時間(秒)。デフォルト: 30秒'
      }
    },
    required: ['code'],
    additionalProperties: false
  },

  // コード実行は排他的に行う
  parallel: false,

  // セキュリティ: ユーザー確認が必要
  requiresConfirmation: true,

  async execute(args, context) {
    const { code, timeout = 30 } = args;
    const timestamp = Date.now();
    const tempFile = join(tmpdir(), `dinreact_${timestamp}.py`);
    const plotFile = join(tmpdir(), `dinreact_plot_${timestamp}.png`);

    try {
      // Python コードをラップ(グラフ自動保存機能を追加)
      const wrappedCode = this._wrapCode(code, plotFile);

      // 一時ファイルに書き込み(UTF-8 エンコーディング)
      await writeFile(tempFile, wrappedCode, 'utf-8');

      // Python を実行
      const result = await this._runPython(tempFile, timeout, context);

      // グラフファイルのチェック
      let plotBase64 = null;
      if (result.stderr.includes('[PLOT_SAVED:')) {
        try {
          const plotData = await readFile(plotFile);
          plotBase64 = plotData.toString('base64');
        } catch (e) {
          // グラフファイルが存在しない場合は無視
        }
      }

      // 一時ファイルをクリーンアップ
      await unlink(tempFile).catch(() => {});
      if (plotBase64) {
        await unlink(plotFile).catch(() => {});
      }

      // 結果を整形
      const hasError = result.exitCode !== 0;
      const output = result.stdout || '(出力なし)';

      // ユーザー表示用の詳細フォーマット
      let display = `Python 実行結果:\n${output}`;

      // エラー出力(グラフ関連のメッセージは除外)
      const cleanStderr = this._cleanStderr(result.stderr);
      if (cleanStderr) {
        display += `\n\nエラー出力:\n${cleanStderr}`;
      }

      if (plotBase64) {
        display += `\n\n[グラフ生成完了 - Base64サイズ: ${plotBase64.length} bytes]`;
      }

      // LLM 用の簡潔な出力
      const llmOutput = output + (plotBase64 ? '\n\n[グラフが生成されました]' : '');

      return {
        success: !hasError,
        output: llmOutput,
        display,
        error: hasError ? cleanStderr : undefined,
        metadata: {
          exitCode: result.exitCode,
          executionTime: result.executionTime,
          hasPlot: !!plotBase64,
          plotBase64
        }
      };

    } catch (error) {
      // エラー時もクリーンアップ
      await unlink(tempFile).catch(() => {});
      await unlink(plotFile).catch(() => {});

      return {
        success: false,
        output: `実行エラー: ${error.message}`,
        error: error.message
      };
    }
  },

  /**
   * Python コードをラップしてグラフ自動保存機能を追加
   * @private
   */
  _wrapCode(code, plotFilePath) {
    // Windows パスのバックスラッシュをエスケープ
    const escapedPath = plotFilePath.replace(/\\/g, '\\\\');

    return `# -*- coding: utf-8 -*-
import sys

# グラフ保存用の内部変数
_dinreact_plot_file = r'${escapedPath}'

# matplotlib の日本語フォント設定(自動)
try:
    import matplotlib
    import platform

    # バックエンドを先に設定(TkAgg で GUI 表示)
    matplotlib.use('TkAgg')

    import matplotlib.pyplot as plt
    import matplotlib.font_manager as fm

    # 利用可能な日本語フォントを検索
    jp_fonts = []
    if platform.system() == 'Windows':
        # Windows の日本語フォント
        font_candidates = ['Yu Gothic', 'MS Gothic', 'Meiryo', 'MS UI Gothic', 'MS PGothic']
    elif platform.system() == 'Darwin':  # macOS
        font_candidates = ['Hiragino Sans', 'Hiragino Kaku Gothic Pro', 'AppleGothic']
    else:  # Linux
        font_candidates = ['Noto Sans CJK JP', 'IPAGothic', 'IPAMincho', 'TakaoGothic']

    # システムで利用可能なフォントから検索
    available_fonts = [f.name for f in fm.fontManager.ttflist]
    for font_name in font_candidates:
        if font_name in available_fonts:
            jp_fonts.append(font_name)
            break

    # フォント設定を適用
    if jp_fonts:
        matplotlib.rcParams['font.sans-serif'] = jp_fonts + matplotlib.rcParams['font.sans-serif']
        matplotlib.rcParams['font.family'] = 'sans-serif'

    # マイナス記号の文字化け防止
    matplotlib.rcParams['axes.unicode_minus'] = False
except ImportError:
    # matplotlib がない場合は無視
    pass

# ========== ユーザーコード ==========
${code}
# ====================================

# matplotlib グラフの表示と保存
try:
    import matplotlib.pyplot as plt
    if plt.get_fignums():  # グラフが存在するかチェック
        # 先に保存
        plt.savefig(_dinreact_plot_file, dpi=150, bbox_inches='tight')
        print(f"[PLOT_SAVED:{_dinreact_plot_file}]", file=sys.stderr)

        # GUI ウィンドウで表示(5分間表示)
        plt.show(block=False)
        plt.pause(300)  # 5分間表示を維持
except ImportError:
    # matplotlib がインストールされていない場合は無視
    pass
except Exception as e:
    # グラフ保存エラーは警告のみ
    print(f"[PLOT_ERROR:{e}]", file=sys.stderr)
`;
  },

  /**
   * Python プロセスを実行
   * @private
   */
  async _runPython(scriptPath, timeoutSec, context) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();

      // エンコーディング問題を解決するための環境変数設定
      // Layer 1: Python プロセスレベルでの UTF-8 強制
      const env = {
        ...process.env,
        PYTHONIOENCODING: 'utf-8',   // Python 2/3 の IO エンコーディング
        PYTHONUTF8: '1',              // Python 3.7+ の UTF-8 モード
        PYTHONUNBUFFERED: '1'         // バッファリング無効(リアルタイム出力)
      };

      // Python プロセス起動
      const python = spawn('python', [scriptPath], {
        cwd: context.cwd,
        env,
        timeout: timeoutSec * 1000
      });

      let stdout = '';
      let stderr = '';

      // Layer 2: Node.js レベルでの UTF-8 デコーディング
      python.stdout.setEncoding('utf-8');
      python.stderr.setEncoding('utf-8');

      python.stdout.on('data', (data) => {
        stdout += data;
      });

      python.stderr.on('data', (data) => {
        stderr += data;
      });

      python.on('close', (exitCode) => {
        resolve({
          stdout: stdout.trim(),
          stderr: stderr.trim(),
          exitCode: exitCode || 0,
          executionTime: Date.now() - startTime
        });
      });

      python.on('error', (error) => {
        reject(new Error(`Python 起動失敗: ${error.message}`));
      });

      // タイムアウト処理
      const timer = setTimeout(() => {
        if (!python.killed) {
          python.kill();
          reject(new Error(`タイムアウト(${timeoutSec}秒)`));
        }
      }, timeoutSec * 1000);

      python.on('close', () => {
        clearTimeout(timer);
      });

      // キャンセル対応
      if (context.abortSignal) {
        context.abortSignal.addEventListener('abort', () => {
          if (!python.killed) {
            python.kill();
            clearTimeout(timer);
            reject(new Error('ユーザーによってキャンセルされました'));
          }
        });
      }
    });
  },

  /**
   * stderr から内部メッセージを除去
   * @private
   */
  _cleanStderr(stderr) {
    if (!stderr) return '';

    // [PLOT_SAVED:...] や [PLOT_ERROR:...] などの内部メッセージを除去
    return stderr
      .split('\n')
      .filter(line => !line.includes('[PLOT_SAVED:') && !line.includes('[PLOT_ERROR:'))
      .join('\n')
      .trim();
  }
};

export default pythonExecutor;
