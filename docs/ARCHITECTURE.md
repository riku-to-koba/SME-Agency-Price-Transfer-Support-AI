# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

## å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
graph TB
    User[ãƒ¦ãƒ¼ã‚¶ãƒ¼<br/>ä¸­å°ä¼æ¥­æ‹…å½“è€…] -->|è³ªå•å…¥åŠ›| UI[React UI<br/>frontend/src/App.tsx]
    UI -->|HTTP POST| API[FastAPI<br/>api/main.py]

    API -->|1. ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã‚’è‡ªå‹•å®Ÿè¡Œ| Detect[detect_current_step<br/>tools/step_detector.py]
    Detect -->|åˆ¤å®šçµæœ| API

    API -->|2. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°| Update[current_stepè¨­å®š<br/>sessionsç®¡ç†]
    Update -->|3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†åˆæœŸåŒ–| Reload[PriceTransferAgent<br/>æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§]

    Reload -->|4. è³ªå•ã‚’é€ä¿¡| Agent[PriceTransferAgent<br/>agent/core.py]
    Agent -->|ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆ| Prompt[ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>åŸºæœ¬+ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±+ã‚¹ãƒ†ãƒƒãƒ—åˆ¥]

    Agent -->|5. ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ| Tools[ãƒ„ãƒ¼ãƒ«ç¾¤]

    Tools --> KB[search_knowledge_base<br/>ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¤œç´¢]
    Tools --> Web[web_search<br/>AIä¿¡é ¼æ€§åˆ¤å®šä»˜ã]
    Tools --> Calc[calculator<br/>è¨ˆç®—]
    Tools --> Diagram[generate_diagram<br/>å›³ç”Ÿæˆ]
    Tools --> Cost[analyze_cost_impact<br/>ã‚³ã‚¹ãƒˆåˆ†æ]

    KB --> Response[å›ç­”ç”Ÿæˆ]
    Web --> Response
    Calc --> Response
    Diagram --> Response
    Cost --> Response

    Response -->|SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°| API
    API -->|SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°| UI
    UI -->|è¡¨ç¤º| User

    style User fill:#FFE4B5
    style UI fill:#E0F7FA
    style Agent fill:#C8E6C9
    style Detect fill:#FFECB3
    style Update fill:#FFECB3
    style Reload fill:#FFECB3
    style Tools fill:#B3E5FC
    style Response fill:#C8E6C9
```

## ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã¨å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ‡ã‚Šæ›¿ãˆï¼ˆæœ€æ–°ãƒ•ãƒ­ãƒ¼ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as React UI
    participant API as FastAPI
    participant Detector as ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š
    participant Agent as PriceTransferAgent
    participant Prompt as ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    participant Tools as ãƒ„ãƒ¼ãƒ«ç¾¤

    User->>UI: ã€ŒåŸä¾¡è¨ˆç®—ã®ã‚„ã‚Šæ–¹ã‚’æ•™ãˆã¦ã€
    UI->>API: POST /api/chat

    Note over API,Detector: ã€é‡è¦ã€‘è³ªå•ã®æœ€åˆã«è‡ªå‹•å®Ÿè¡Œ
    API->>Detector: detect_current_step<br/>(è³ªå• + ä¼šè©±æ–‡è„ˆ)
    Detector->>Detector: Claude Haikuã§åˆ¤å®š
    Detector-->>API: {"step": "STEP_0_CHECK_3",<br/>"confidence": "high",<br/>"reasoning": "åŸä¾¡è¨ˆç®—ã«ã¤ã„ã¦è³ªå•"}

    API->>API: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°<br/>current_step = "STEP_0_CHECK_3"
    API->>UI: SSEã‚¤ãƒ™ãƒ³ãƒˆ: step_update
    UI->>User: ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºæ›´æ–°<br/>ã€ŒğŸ“Œ ä¾¡æ ¼äº¤æ¸‰æº–å‚™ç·¨ - åŸä¾¡è¨ˆç®—ã®å®Ÿæ–½ã€

    API->>Agent: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†åˆæœŸåŒ–<br/>(current_step="STEP_0_CHECK_3")

    Agent->>Prompt: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆ<br/>åŸºæœ¬ + ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± + CHECK 3ç”¨

    Agent->>Agent: è³ªå•ã‚’å‡¦ç†
    Agent->>Tools: æ¨å¥¨ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ<br/>search_knowledge_base<br/>calculator<br/>generate_diagram

    Tools-->>Agent: ãƒ„ãƒ¼ãƒ«çµæœ

    Agent->>API: CHECK 3ã«ç‰¹åŒ–ã—ãŸ<br/>è©³ã—ã„å›ç­”
    API->>UI: SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

    UI->>User: è¡¨ç¤ºï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼‰
```

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆï¼ˆ3ã¤ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‹•çš„ã«çµåˆï¼‰

```mermaid
graph LR
    Base[åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>MAIN_SYSTEM_PROMPT] --> Final[æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]

    UserInfo{ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±<br/>ã‚ã‚Š?} -->|Yes| UI[ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>æ¥­ç¨®ãƒ»è¦æ¨¡ãƒ»åœ°åŸŸãªã©]
    UserInfo -->|No| Final
    UI --> Final

    Step{åˆ¤å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—} -->|STEP 0 - CHECK 1| C1[CHECK 1ç”¨<br/>å–å¼•æ¡ä»¶ç¢ºèª]
    Step -->|STEP 0 - CHECK 2| C2[CHECK 2ç”¨<br/>ãƒ‡ãƒ¼ã‚¿åé›†]
    Step -->|STEP 0 - CHECK 3| C3[CHECK 3ç”¨<br/>åŸä¾¡è¨ˆç®—]
    Step -->|STEP 0 - CHECK 4| C4[CHECK 4ç”¨<br/>å˜ä¾¡è¡¨ä½œæˆ]
    Step -->|STEP 0 - CHECK 5| C5[CHECK 5ç”¨<br/>è¦‹ç©æ›¸æ•´å‚™]
    Step -->|STEP 0 - CHECK 6| C6[CHECK 6ç”¨<br/>å–å¼•å…ˆæŠŠæ¡]
    Step -->|STEP 0 - CHECK 7| C7[CHECK 7ç”¨<br/>ä»˜åŠ ä¾¡å€¤æ˜ç¢ºåŒ–]
    Step -->|STEP 0 - CHECK 8| C8[CHECK 8ç”¨<br/>å–å¼•æ…£è¡Œç¢ºèª]
    Step -->|STEP 0 - CHECK 9| C9[CHECK 9ç”¨<br/>ä¾¡æ ¼è»¢å«å¿…è¦æ€§åˆ¤å®š]
    Step -->|STEP 1| S1[STEP 1ç”¨<br/>æ¥­ç•Œå‹•å‘]
    Step -->|STEP 2-5| S2[STEP 2-5ç”¨<br/>å®Ÿè·µç·¨]
    Step -->|None| Final

    C1 --> Final
    C2 --> Final
    C3 --> Final
    C4 --> Final
    C5 --> Final
    C6 --> Final
    C7 --> Final
    C8 --> Final
    C9 --> Final
    S1 --> Final
    S2 --> Final

    Final --> Agent[PriceTransferAgent]

    style Base fill:#FFF9C4
    style UI fill:#FFE4B5
    style C3 fill:#FF6B6B
    style C9 fill:#FF6B6B
    style Final fill:#C8E6C9
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    Session[FastAPI Sessions<br/>api/main.py] -->|ä¿æŒ| SID[session_id]
    Session -->|ä¿æŒ| MSG[messages<br/>ä¼šè©±å±¥æ­´]
    Session -->|ä¿æŒ| AGT[agent<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹]
    Session -->|ä¿æŒ| STEP[current_step<br/>åˆ¤å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—]
    Session -->|ä¿æŒ| USER[user_info<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¼æ¥­æƒ…å ±]
    Session -->|ä¿æŒ| TIME[created_at<br/>ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚åˆ»]

    React[React State] -->|å–å¾—| API[GET /api/session/{id}/messages]
    React -->|æ›´æ–°| API2[POST /api/chat]

    STEP -->|ä¾‹| E1["STEP_0_CHECK_3"]
    STEP -->|ä¾‹| E2["STEP_0_CHECK_9"]
    STEP -->|ä¾‹| E3["None (æœªåˆ¤å®š)"]

    STEP --> Update{ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°?}
    Update -->|Yes| Reinit[ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†åˆæœŸåŒ–<br/>æ–°ã—ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§]
    Update -->|No| Keep[ç¾çŠ¶ç¶­æŒ]

    USER -->|ä¾‹| U1["industry: è£½é€ æ¥­<br/>products: é‡‘å±åŠ å·¥éƒ¨å“"]
    USER --> Personalize[ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸ<br/>ã‚¢ãƒ‰ãƒã‚¤ã‚¹]

    style Session fill:#FFFDE7
    style STEP fill:#FFECB3
    style USER fill:#E1BEE7
    style E1 fill:#FF6B6B
    style E2 fill:#FF6B6B
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨è²¬å‹™

```mermaid
graph TB
    subgraph UIå±¤
        FRONTEND[frontend/src/App.tsx<br/>React UI<br/>ãƒ»ãƒãƒ£ãƒƒãƒˆç”»é¢<br/>ãƒ»SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¡¨ç¤º<br/>ãƒ»Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°<br/>ãƒ»å›³ã®è¡¨ç¤º<br/>ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«<br/>ãƒ»ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«]
    end

    subgraph APIå±¤
        API[api/main.py<br/>FastAPI<br/>ãƒ»REST API<br/>ãƒ»SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°<br/>ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†<br/>ãƒ»è³ªå•ã®æœ€åˆã«ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã‚’è‡ªå‹•å®Ÿè¡Œ]
    end

    subgraph ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå±¤
        CORE[agent/core.py<br/>PriceTransferAgent<br/>ãƒ»åˆæœŸåŒ–<br/>ãƒ»ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°<br/>ãƒ»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹æˆ<br/>ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ]
        PROMPT[agent/prompts.py<br/>ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>ãƒ»åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>ãƒ»ã‚¹ãƒ†ãƒƒãƒ—åˆ¥è¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>ãƒ»å…¨14ã‚¹ãƒ†ãƒƒãƒ—å¯¾å¿œ]
    end

    subgraph ãƒ„ãƒ¼ãƒ«å±¤
        DETECTOR[tools/step_detector.py<br/>ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š<br/>ãƒ»LLMãƒ™ãƒ¼ã‚¹åˆ¤å®š<br/>ãƒ»Claude Haikuä½¿ç”¨<br/>ãƒ»ä¼šè©±æ–‡è„ˆè€ƒæ…®<br/>ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯]
        DIAGRAM[tools/diagram_generator.py<br/>å›³ç”Ÿæˆãƒ„ãƒ¼ãƒ«<br/>ãƒ»matplotlibå®Ÿè¡Œ<br/>ãƒ»ãƒ‡ãƒ¼ã‚¿æŠ½å‡º<br/>ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç´ä»˜ã‘]
        WEB[tools/web_search.py<br/>Webæ¤œç´¢<br/>ãƒ»Tavily API<br/>ãƒ»AIä¿¡é ¼æ€§åˆ¤å®š<br/>ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯]
        KB[tools/knowledge_base.py<br/>Knowledge Baseæ¤œç´¢<br/>ãƒ»ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢<br/>ãƒ»ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯]
        COST[tools/cost_analysis.py<br/>ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«<br/>ãƒ»ã‚³ã‚¹ãƒˆåˆ†æ<br/>ãƒ»åˆ©ç›Šç‡è¨ˆç®—<br/>ãƒ»å‚è€ƒä¾¡æ ¼ç®—å‡º]
    end

    FRONTEND --> API
    API --> CORE
    API --> DETECTOR
    CORE --> PROMPT
    CORE --> DIAGRAM
    CORE --> WEB
    CORE --> KB
    CORE --> COST

    style FRONTEND fill:#E0F7FA
    style API fill:#FFE4B5
    style CORE fill:#C8E6C9
    style PROMPT fill:#FFF9C4
    style DETECTOR fill:#FFECB3
    style DIAGRAM fill:#B3E5FC
    style WEB fill:#B3E5FC
    style KB fill:#B3E5FC
    style COST fill:#B3E5FC
```

## ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã®æŸ”è»Ÿæ€§

```mermaid
graph TD
    Question[ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•] --> Type{è³ªå•ã‚¿ã‚¤ãƒ—}

    Type -->|ã‚¹ãƒ†ãƒƒãƒ—ç‰¹åŒ–| Specific[ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—<br/>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å›ç­”]
    Type -->|å…¨èˆ¬çš„ãªè³ªå•| General[ã‚¹ãƒ†ãƒƒãƒ—ã«é–¢ä¿‚ãªã<br/>ä¸€èˆ¬çš„ã«å›ç­”]
    Type -->|åˆ¥ã®ã‚¹ãƒ†ãƒƒãƒ—| Other[ãã®è³ªå•ã«å›ç­”<br/>+ ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´ææ¡ˆ]

    Specific --> Keep1[ã‚¹ãƒ†ãƒƒãƒ—ç¶­æŒ]
    General --> Keep2[ã‚¹ãƒ†ãƒƒãƒ—ç¶­æŒ]
    Other --> Suggest{ã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´?}

    Suggest -->|Yes| Change[æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã§<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†åˆæœŸåŒ–]
    Suggest -->|No| Keep3[ã‚¹ãƒ†ãƒƒãƒ—ç¶­æŒ]

    style Type fill:#FFECB3
    style Specific fill:#C8E6C9
    style General fill:#B3E5FC
    style Other fill:#FFE4B5
```

---

## é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

### 1. ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã¯è³ªå•ã®æœ€åˆã«è‡ªå‹•å®Ÿè¡Œï¼ˆé‡è¦ãªå¤‰æ›´ç‚¹ï¼‰

- **æ—§ä»•æ§˜**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ‰‹å‹•ã§ `detect_current_step` ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™
- **æ–°ä»•æ§˜**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è³ªå•ã®æœ€åˆã«è‡ªå‹•å®Ÿè¡Œï¼ˆ[api/main.py:221-289](api/main.py#L221-L289)ï¼‰
- **ãƒ¡ãƒªãƒƒãƒˆ**:
  - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒãªã„
  - ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šãŒç¢ºå®Ÿã«å®Ÿè¡Œã•ã‚Œã‚‹
  - åˆ¤å®šçµæœã«åŸºã¥ã„ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§åˆæœŸåŒ–ã•ã‚Œã‚‹

### 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‹•çš„åˆ‡ã‚Šæ›¿ãˆï¼ˆ3ã¤ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµåˆï¼‰

- **åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ** + **ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ** + **ã‚¹ãƒ†ãƒƒãƒ—åˆ¥è¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯ã€æ¥­ç¨®ã‚„è¦æ¨¡ã«å¿œã˜ãŸå…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›
- ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šå¾Œã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å†åˆæœŸåŒ–ã—ã¦æœ€é©åŒ–

### 3. ãƒ„ãƒ¼ãƒ«ã®æ¨å¥¨ä½¿ç”¨

- å„ã‚¹ãƒ†ãƒƒãƒ—ã«å¿œã˜ã¦æ¨å¥¨ãƒ„ãƒ¼ãƒ«ã‚’è‡ªå‹•çš„ã«ä½¿ç”¨
- ä¾‹: CHECK 3 ã§ã¯ `search_knowledge_base` + `calculator` + `generate_diagram`
- ä¾‹: CHECK 9 ã§ã¯ `analyze_cost_impact`ï¼ˆä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ï¼‰ã‚’ç©æ¥µçš„ã«æ¨å¥¨

### 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®æ´»ç”¨

- `current_step` ã§ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç®¡ç†ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ç®¡ç†ï¼‰
- `user_info` ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¼æ¥­æƒ…å ±ã‚’ç®¡ç†
- `created_at` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆå›³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã«ä½¿ç”¨ï¼‰
- ä¼šè©±ä¸­ã«ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤‰ã‚ã£ã¦ã‚‚å¯¾å¿œå¯èƒ½
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã‚’æ›´æ–°

### 5. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†é›¢

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScriptï¼ˆUIå±¤ï¼‰
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: FastAPIï¼ˆAPIå±¤ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: Strands Agentsï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰
- **ãƒ„ãƒ¼ãƒ«**: å„ç¨®ãƒ„ãƒ¼ãƒ«å®Ÿè£…ï¼ˆæ©Ÿèƒ½å±¤ï¼‰

### 6. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè£…

- Server-Sent Events (SSE) ã‚’ä½¿ç”¨
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãƒ„ãƒ¼ãƒ«ä½¿ç”¨çŠ¶æ³ã€ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°ã‚’é€ä¿¡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

---

## ãƒ„ãƒ¼ãƒ«è©³ç´°

### `web_search` (tools/web_search.py)
**ç›®çš„**: Webæ¤œç´¢ã‚’å®Ÿè¡Œã—ã€AIåˆ¤å®šã«ã‚ˆã‚Šä¿¡é ¼ã§ãã‚‹æƒ…å ±æºã®ã¿ã‚’è¡¨ç¤º

**æ©Ÿèƒ½**:
- Tavily APIã‚’ä½¿ç”¨ã—ãŸWebæ¤œç´¢
- **AIä¿¡é ¼æ€§åˆ¤å®šæ©Ÿèƒ½**: Claude HaikuãŒå„æ¤œç´¢çµæœã®URLã€ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è©•ä¾¡
- ä¿¡é ¼ã§ãã‚‹å…¬çš„æ©Ÿé–¢ï¼ˆæ”¿åºœæ©Ÿé–¢ã€è‡ªæ²»ä½“ã€æ”¯æ´æ©Ÿé–¢ã€ä¼æ¥­ã‚µã‚¤ãƒˆã€ãƒ¡ãƒ‡ã‚£ã‚¢ãªã©ï¼‰ã®ã‚½ãƒ¼ã‚¹ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ã‚½ãƒ¼ã‚¹ç¨®åˆ¥ã‚’è‡ªå‹•åˆ†é¡ï¼ˆæ”¿åºœæ©Ÿé–¢/å…¬çš„æ©Ÿé–¢/å­¦è¡“æ©Ÿé–¢/æ¥­ç•Œãƒ¡ãƒ‡ã‚£ã‚¢/ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ¡ãƒ‡ã‚£ã‚¢/ãƒ‡ãƒ¼ã‚¿æä¾›ã‚µã‚¤ãƒˆ/æ¥­ç•Œå›£ä½“/ä¼æ¥­ã‚µã‚¤ãƒˆï¼‰
- æœ€å¤§5ä»¶ã®æ¤œç´¢çµæœã‚’å–å¾—
- **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ™‚ã«æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤

**AIä¿¡é ¼æ€§åˆ¤å®šã®ä»•çµ„ã¿**:
1. Tavily APIã§æ¤œç´¢çµæœã‚’å–å¾—ï¼ˆå¤šã‚ã«å–å¾—ï¼‰
2. å„çµæœã«å¯¾ã—ã¦`is_trusted_source_ai()`ã‚’å®Ÿè¡Œ
3. Claude HaikuãŒä»¥ä¸‹ã‚’åˆ¤å®š:
   - ä¿¡é ¼æ€§ã®å¯å¦ï¼ˆis_trustedï¼‰
   - åˆ¤å®šç†ç”±ï¼ˆreasoningï¼‰
   - ã‚½ãƒ¼ã‚¹ç¨®åˆ¥ï¼ˆsource_typeï¼‰
4. ä¿¡é ¼ã§ãã‚‹ã¨åˆ¤å®šã•ã‚ŒãŸçµæœã®ã¿ã‚’è¿”å´

**åˆ¤å®šåŸºæº–**:
- âœ… **ä¿¡é ¼ã§ãã‚‹**: æ”¿åºœæ©Ÿé–¢(.go.jp)ã€åœ°æ–¹è‡ªæ²»ä½“(.lg.jp)ã€å…¬çš„æ”¯æ´æ©Ÿé–¢ã€å¤§å­¦ãƒ»ç ”ç©¶æ©Ÿé–¢(.ac.jp)ã€ä¿¡é ¼ã§ãã‚‹æ¥­ç•Œå›£ä½“ã€ä¼æ¥­ã‚µã‚¤ãƒˆã€ãƒ¡ãƒ‡ã‚£ã‚¢ã€ãƒ‡ãƒ¼ã‚¿æä¾›ã‚µã‚¤ãƒˆ
- âŒ **ä¿¡é ¼ã§ããªã„**: å€‹äººãƒ–ãƒ­ã‚°ã€ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã‚µã‚¤ãƒˆã€ã¾ã¨ã‚ã‚µã‚¤ãƒˆã€åºƒå‘Šç›®çš„ã‚µã‚¤ãƒˆ

### `search_knowledge_base` (tools/knowledge_base.py)
**ç›®çš„**: AWS Bedrock Knowledge Baseã‹ã‚‰ä¾¡æ ¼è»¢å«é–¢é€£æƒ…å ±ã‚’æ¤œç´¢

**æ©Ÿèƒ½**:
- ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ID: `7SM8UQNQFL` (ap-northeast-1)
- ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ï¼ˆãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼‰
- æœ€å¤§5ä»¶ã®çµæœã‚’å–å¾—
- å‡ºå…¸ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
- S3ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
- **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ™‚ã«æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤

**ä½¿ç”¨å ´é¢**:
- Knowledge Baseã‚’æœ€å„ªå…ˆã§ä½¿ç”¨
- å…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚„ä¾¡æ ¼è»¢å«äº‹ä¾‹ã‚’æ¤œç´¢
- å…·ä½“çš„ãªæ‰‹é †ã‚„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å–å¾—

### `detect_current_step` (tools/step_detector.py)
**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‹ã‚‰ä¾¡æ ¼è»¢å«ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è‡ªå‹•åˆ¤å®š

**æ©Ÿèƒ½**:
- Claude Haikuã‚’ä½¿ç”¨ã—ãŸLLMãƒ™ãƒ¼ã‚¹åˆ¤å®š
- STEP 0 (CHECK 1ã€œ9) ãŠã‚ˆã³ STEP 1ã€œ5 ã«å¯¾å¿œ
- åˆ¤å®šç†ç”±ã¨ä¿¡é ¼åº¦ï¼ˆhigh/medium/lowï¼‰ã‚’è¿”å´
- è©³ç´°ãªãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
- ä¼šè©±ã®æ–‡è„ˆã‚’è€ƒæ…®ã—ãŸåˆ¤å®š
- **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼æ™‚ã«æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤

**åˆ¤å®šãƒ•ãƒ­ãƒ¼**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•å†…å®¹ã¨ä¼šè©±æ–‡è„ˆã‚’åˆ†æ
2. ä¾¡æ ¼è»¢å«ãƒ—ãƒ­ã‚»ã‚¹ã®å„ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã¨ç…§åˆ
3. æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ¤å®š
4. JSONå½¢å¼ã§çµæœã‚’è¿”å´: `{"step": "STEP_0_CHECK_3", "confidence": "high", "reasoning": "..."}`

**é‡è¦**: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è³ªå•ã®æœ€åˆã«è‡ªå‹•å®Ÿè¡Œï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒæ‰‹å‹•ã§å‘¼ã³å‡ºã™å¿…è¦ãªã—ï¼‰

### `analyze_cost_impact` (tools/cost_analysis.py)
**ç›®çš„**: ã‚³ã‚¹ãƒˆé«˜é¨°ã®å½±éŸ¿ã‚’åˆ†æã—ã€ä¾¡æ ¼è»¢å«ã®å¿…è¦æ€§ã‚’åˆ¤å®š

**ä½¿ç”¨å ´é¢**: STEP 0 - CHECK 9ï¼ˆä¾¡æ ¼è»¢å«ã®å¿…è¦æ€§åˆ¤å®šï¼‰

**æ©Ÿèƒ½**:
- ã‚³ã‚¹ãƒˆé«˜é¨°å‰ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒ
- åˆ©ç›Šç‡ã®å¤‰åŒ–ã‚’è¨ˆç®—
- å„ã‚³ã‚¹ãƒˆé …ç›®ã®å¢—æ¸›ç‡ãƒ»å¢—æ¸›é¡ã‚’è¨ˆç®—
- ã‚³ã‚¹ãƒˆé«˜é¨°å‰ã®åˆ©ç›Šç‡ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®å‚è€ƒä¾¡æ ¼ã‚’ç®—å‡º
- ä¾¡æ ¼è»¢å«ã®å¿…è¦æ€§ã‚’åˆ¤å®š
- **è‡ªå‹•å›³ç”Ÿæˆ**: åˆ†æçµæœã«åŸºã¥ã„ã¦æ£’ã‚°ãƒ©ãƒ•ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆå›³ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€ï¼‰

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æº**:
- STEP 9åˆ¤å®šæ™‚ã€ã€ŒğŸ“Š ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ã§åˆ†æã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
- ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ãƒ‡ãƒ¼ã‚¿å…¥åŠ› â†’ åˆ†æå®Ÿè¡Œ â†’ çµæœã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«é€ä¿¡ â†’ è¦ç´„ + å›³ç”Ÿæˆ

### `generate_diagram` (tools/diagram_generator.py)
**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã™ã‚‹å›³ã‚’è‡ªå‹•ç”Ÿæˆ

**æ©Ÿèƒ½**:
- 4ç¨®é¡ã®å›³ã«å¯¾å¿œ: æ£’ã‚°ãƒ©ãƒ•ã€æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã€ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³
- description ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æŠ½å‡ºï¼ˆJSONå½¢å¼ã€ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã€ãƒªã‚¹ãƒˆå½¢å¼ï¼‰
- ç”Ÿæˆã•ã‚ŒãŸå›³ã¯ `diagrams/` ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç´ã¥ãå›³ã®ã¿è¡¨ç¤ºï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚åˆ»ä»¥é™ã®å›³ï¼‰
- UIä¸Šã§æœ€æ–°ã®å›³ã‚’è‡ªå‹•è¡¨ç¤ºï¼ˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç›´å¾Œï¼‰
- æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œï¼ˆWindows/macOS/Linuxï¼‰

**ä½¿ç”¨å ´é¢**:
- åŸä¾¡æ§‹é€ ã®å¯è¦–åŒ–ï¼ˆSTEP 0 - CHECK 3ï¼‰
- ä¾¡æ ¼æ¨ç§»ã®ã‚°ãƒ©ãƒ•åŒ–
- ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼ã®å›³ç¤º
- ã‚³ã‚¹ãƒˆåˆ†æçµæœã®å¯è¦–åŒ–ï¼ˆSTEP 0 - CHECK 9ï¼‰

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼: Webæ¤œç´¢ï¼ˆAIä¿¡é ¼æ€§åˆ¤å®šä»˜ãï¼‰

```mermaid
sequenceDiagram
    participant Agent as ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    participant WebTool as web_search
    participant Tavily as Tavily API
    participant AIJudge as AIä¿¡é ¼æ€§åˆ¤å®š
    participant Haiku as Claude Haiku

    Agent->>WebTool: ã‚¯ã‚¨ãƒªã§æ¤œç´¢å®Ÿè¡Œ
    WebTool->>Tavily: æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå¤šã‚ã«å–å¾—ï¼‰
    Tavily-->>WebTool: æ¤œç´¢çµæœï¼ˆè¤‡æ•°ä»¶ï¼‰

    loop å„æ¤œç´¢çµæœ
        WebTool->>AIJudge: URL, ã‚¿ã‚¤ãƒˆãƒ«, ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        AIJudge->>Haiku: ä¿¡é ¼æ€§åˆ¤å®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        Haiku-->>AIJudge: JSONåˆ¤å®šçµæœ
        AIJudge-->>WebTool: is_trusted, reasoning, source_type

        alt ä¿¡é ¼ã§ãã‚‹
            WebTool->>WebTool: çµæœã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ãƒªã‚¹ãƒˆã«è¿½åŠ 
        else ä¿¡é ¼ã§ããªã„
            WebTool->>WebTool: é™¤å¤–ï¼ˆç†ç”±ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼‰
        end
    end

    WebTool-->>Agent: ä¿¡é ¼ã§ãã‚‹çµæœã®ã¿è¿”å´
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼: ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ï¼ˆCHECK 9å°‚ç”¨ï¼‰

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as React UI
    participant API as FastAPI
    participant Agent as ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    participant CostTool as analyze_cost_impact
    participant DiagramTool as generate_diagram

    User->>UI: ã€Œä¾¡æ ¼è»¢å«ãŒå¿…è¦ã‹åˆ¤æ–­ã—ãŸã„ã€
    UI->>API: POST /api/chat

    API->>API: ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š<br/>â†’ STEP_0_CHECK_9
    API->>Agent: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå†åˆæœŸåŒ–<br/>(CHECK 9ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)

    Agent->>UI: ã€Œä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€
    UI->>User: ã€ŒğŸ“Š ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«ã§åˆ†æã™ã‚‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤º

    User->>UI: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    UI->>User: ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º

    User->>UI: ãƒ‡ãƒ¼ã‚¿å…¥åŠ›<br/>(ã‚³ã‚¹ãƒˆé«˜é¨°å‰ãƒ»ç¾åœ¨)
    UI->>API: POST /api/cost-analysis

    API->>CostTool: åˆ†æå®Ÿè¡Œ
    CostTool-->>API: åˆ†æçµæœ + å›³ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿

    API->>UI: åˆ†æçµæœ
    UI->>API: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«çµæœé€ä¿¡<br/>(skipUserMessage=true)

    API->>Agent: åˆ†æçµæœã‚’è¦ç´„
    Agent->>DiagramTool: å›³ç”ŸæˆæŒ‡ç¤º<br/>(æ£’ã‚°ãƒ©ãƒ•)
    DiagramTool-->>Agent: å›³ç”Ÿæˆå®Œäº†

    Agent->>UI: è¦ç´„ + å›³
    UI->>User: è¡¨ç¤º
```

---

## Reactç‰ˆã¸ã®ç§»è¡Œ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´ç‚¹

**æ—§æ§‹æˆï¼ˆStreamlitç‰ˆï¼‰:**
- UIã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒçµ±åˆï¼ˆ`app.py`ï¼‰
- Streamlitã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- Streamlitç‹¬è‡ªã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

**æ–°æ§‹æˆï¼ˆReactç‰ˆï¼‰:**
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScriptï¼ˆ`frontend/`ï¼‰
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: FastAPIï¼ˆ`api/main.py`ï¼‰
- **åˆ†é›¢**: UIå±¤ã¨APIå±¤ã‚’æ˜ç¢ºã«åˆ†é›¢
- **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°**: Server-Sent Events (SSE)
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: FastAPIã®ãƒ¡ãƒ¢ãƒªç®¡ç†

### é€šä¿¡ãƒ•ãƒ­ãƒ¼

```
React UI (ãƒãƒ¼ãƒˆ5173)
    â†“ HTTP POST
FastAPI (ãƒãƒ¼ãƒˆ8000)
    â†“ ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
    â†“ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—
PriceTransferAgent
    â†“ ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œ
å„ç¨®ãƒ„ãƒ¼ãƒ«
    â†“ çµæœè¿”å´
FastAPI
    â†“ SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
React UI (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®é•ã„

**Streamlitç‰ˆ:**
```python
st.session_state = {
    "session_id": str,
    "messages": list,
    "agent": PriceTransferAgent,
    "current_step": str | None
}
```

**Reactç‰ˆ:**
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: FastAPIã®ãƒ¡ãƒ¢ãƒªä¸Šã§ç®¡ç†
```python
sessions[session_id] = {
    "session_id": str,
    "messages": list,
    "agent": PriceTransferAgent,
    "current_step": str | None,
    "user_info": dict | None,
    "created_at": float
}
```
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React Stateã§è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
```typescript
const [sessionId, setSessionId] = useState<string | null>(null)
const [messages, setMessages] = useState<Message[]>([])
const [currentStep, setCurrentStep] = useState<string | null>(null)
const [userInfo, setUserInfo] = useState<UserInfo>({})
const [latestDiagram, setLatestDiagram] = useState<string | null>(null)
```
- APIçµŒç”±ã§åŒæœŸ

### èµ·å‹•æ–¹æ³•

è©³ç´°ã¯ `README_REACT.md` ã‚’å‚ç…§ã€‚

**ç°¡å˜ãªèµ·å‹•:**
```bash
start_all.bat  # Windows
```

**å€‹åˆ¥èµ·å‹•:**
```bash
# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«1
python api/main.py

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«2
cd frontend
npm run dev
```

---

## SSEã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆè©³ç´°ï¼‰

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

| ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— | é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒ‡ãƒ¼ã‚¿ä¾‹ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å‡¦ç† |
|-------------|------------|---------|------------------|
| `status` | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ | `{"type": "status", "status": "thinking", "message": "æ€è€ƒä¸­..."}` | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–° |
| `content` | ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆæ™‚ | `{"type": "content", "data": "åŸä¾¡è¨ˆç®—ã«ã¤ã„ã¦..."}` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ãƒ»è¡¨ç¤º |
| `tool_use` | ãƒ„ãƒ¼ãƒ«ä½¿ç”¨é–‹å§‹æ™‚ | `{"type": "tool_use", "tool": "analyze_cost_impact", "show_modal": true}` | ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆãƒ„ãƒ¼ãƒ«ã«ã‚ˆã‚‹ï¼‰ |
| `step_update` | ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šå¾Œ | `{"type": "step_update", "step": "STEP_0_CHECK_3", "confidence": "high", "reasoning": "..."}` | ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã‚’æ›´æ–° |
| `done` | å¿œç­”å®Œäº†æ™‚ | `{"type": "done", "content": "..."}` | ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†ãƒ»æœ€çµ‚è¡¨ç¤º |
| `error` | ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ | `{"type": "error", "error": "ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"}` | ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°

```python
tool_status_messages = {
    "web_search": "æ¤œç´¢ä¸­...",
    "search_knowledge_base": "æ¤œç´¢ä¸­...",
    "generate_diagram": "å›³ã‚’ç”Ÿæˆä¸­...",
    "calculator": "è¨ˆç®—ä¸­...",
    "detect_current_step": "ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ¤å®šä¸­...",
    "analyze_cost_impact": "ã‚³ã‚¹ãƒˆåˆ†æä¸­...",
    "current_time": "æ™‚åˆ»ã‚’å–å¾—ä¸­...",
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

### ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰

**å¯¾è±¡ãƒ„ãƒ¼ãƒ«**:
- `web_search` (AIä¿¡é ¼æ€§åˆ¤å®šéƒ¨åˆ†)
- `search_knowledge_base`
- `detect_current_step`

**ä»•çµ„ã¿**:
1. AWS Bedrock APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ï¼ˆ`ThrottlingException`ï¼‰ã‚’æ¤œçŸ¥
2. æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å¾…æ©Ÿæ™‚é–“ã‚’è¨ˆç®—: `wait_time = retry_delay * (2 ** attempt)`
3. æœ€å¤§5å›ã¾ã§ãƒªãƒˆãƒ©ã‚¤
4. ãƒªãƒˆãƒ©ã‚¤é–“éš”: 2ç§’ â†’ 4ç§’ â†’ 8ç§’ â†’ 16ç§’ â†’ 32ç§’

**å®Ÿè£…ä¾‹**:
```python
max_retries = 5
retry_delay = 2  # åˆæœŸå¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰

for attempt in range(max_retries):
    try:
        response = bedrock_runtime.invoke_model(...)
        break  # æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
    except ClientError as e:
        if e.response.get('Error', {}).get('Code', '') == 'ThrottlingException':
            if attempt < max_retries - 1:
                wait_time = retry_delay * (2 ** attempt)
                print(f"â³ {wait_time}ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¾ã™...")
                time.sleep(wait_time)
                continue
            else:
                raise
        else:
            raise
```

### å¿œç­”ã®åœæ­¢æ©Ÿèƒ½

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:
- `AbortController`ã‚’ä½¿ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- åœæ­¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«`abort()`ã‚’å‘¼ã³å‡ºã—
- åœæ­¢ã•ã‚ŒãŸå ´åˆã€éƒ¨åˆ†çš„ãªå¿œç­”ã‚’å±¥æ­´ã«è¿½åŠ 

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
- `AbortError`ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦å‡¦ç†ã‚’ä¸­æ–­
- éƒ¨åˆ†çš„ãªå¿œç­”ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆç©ºã§ãªã„å ´åˆã®ã¿ï¼‰

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### Webæ¤œç´¢ã®AIä¿¡é ¼æ€§åˆ¤å®š

- **ç›®çš„**: å€‹äººãƒ–ãƒ­ã‚°ã‚„ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã‚µã‚¤ãƒˆã‚’è‡ªå‹•é™¤å¤–
- **ä»•çµ„ã¿**: Claude HaikuãŒå„æ¤œç´¢çµæœã‚’è©•ä¾¡ã—ã€ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºã®ã¿ã‚’è¿”å´
- **åˆ¤å®šåŸºæº–**: æ”¿åºœæ©Ÿé–¢ã€å…¬çš„æ©Ÿé–¢ã€ä¼æ¥­ã‚µã‚¤ãƒˆã€ãƒ¡ãƒ‡ã‚£ã‚¢ãªã©ã‚’å„ªå…ˆ

### Knowledge Baseã®å„ªå…ˆ

- Knowledge Baseã®æƒ…å ±ã‚’æœ€å„ªå…ˆã§ä½¿ç”¨
- è‡ªåˆ†ã®äº‹å‰å­¦ç¿’çŸ¥è­˜ã ã‘ã§å›ç­”ã—ãªã„
- å…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«åŸºã¥ãã‚¢ãƒ‰ãƒã‚¤ã‚¹

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†

- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã¯ãƒ¡ãƒ¢ãƒªä¸Šã®ã¿ï¼ˆæ°¸ç¶šåŒ–ãªã—ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã«ã‚ˆã‚‹åˆ†é›¢

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### å›³ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç´ä»˜ã‘

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚åˆ»ï¼ˆ`created_at`ï¼‰ã‚’è¨˜éŒ²
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚åˆ»ä»¥é™ã®å›³ã®ã¿ã‚’è¡¨ç¤º
- ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å›³ã¯è¡¨ç¤ºã—ãªã„

### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®æœ€é©åŒ–

- ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ£ãƒ³ã‚¯ã‚’å³åº§ã«é€ä¿¡
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€²è¡ŒçŠ¶æ³ã‚’é€šçŸ¥
- ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ä¸­ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®åŠ¹ç‡åŒ–

- ãƒ¡ãƒ¢ãƒªä¸Šã§ç®¡ç†ï¼ˆé«˜é€Ÿã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã«ã‚ˆã‚‹åˆ†é›¢ï¼ˆè¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œï¼‰
- å†èµ·å‹•ã§ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ï¼‰

---

## ä»Šå¾Œã®æ‹¡å¼µæ€§

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŒ–

- ä¼šè©±å±¥æ­´ã®æ°¸ç¶šåŒ–ï¼ˆPostgreSQLã€MongoDBãªã©ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®æ°¸ç¶šåŒ–

### èªè¨¼ãƒ»èªå¯

- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ï¼ˆJWTã€OAuth2ãªã©ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å¼·åŒ–
- ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼å¯¾å¿œï¼ˆãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å¤–éƒ¨åŒ–ï¼ˆRedisã€Memcachedãªã©ï¼‰
- CDNå¯¾å¿œï¼ˆé™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ï¼‰

---

## ä»˜éŒ²: ä¸»è¦ãªã‚³ãƒ¼ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–
- [agent/core.py:16-35](agent/core.py#L16-L35): `PriceTransferAgent.__init__()`
- [agent/core.py:59-94](agent/core.py#L59-L94): `get_system_prompt()`
- [agent/core.py:96-130](agent/core.py#L96-L130): `_build_user_info_prompt()`

### ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®š
- [api/main.py:221-289](api/main.py#L221-L289): è³ªå•ã®æœ€åˆã«ã‚¹ãƒ†ãƒƒãƒ—åˆ¤å®šã‚’è‡ªå‹•å®Ÿè¡Œ
- [tools/step_detector.py:11-225](tools/step_detector.py#L11-L225): `detect_current_step()`

### ãƒ„ãƒ¼ãƒ«å®Ÿè£…
- [tools/web_search.py:10-152](tools/web_search.py#L10-L152): AIä¿¡é ¼æ€§åˆ¤å®š
- [tools/knowledge_base.py:10-144](tools/knowledge_base.py#L10-L144): Knowledge Baseæ¤œç´¢
- [tools/cost_analysis.py:106-272](tools/cost_analysis.py#L106-L272): ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«
- [tools/diagram_generator.py:338-408](tools/diagram_generator.py#L338-L408): å›³ç”Ÿæˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [frontend/src/App.tsx:96-153](frontend/src/App.tsx#L96-L153): ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å…¥åŠ›ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
- [frontend/src/App.tsx:252-433](frontend/src/App.tsx#L252-L433): ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã¨SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°
- [frontend/src/App.tsx:436-557](frontend/src/App.tsx#L436-L557): ä¾¡æ ¼è»¢å«æ¤œè¨ãƒ„ãƒ¼ãƒ«
