# 価格転嫁支援AIアシスタント - 要件定義書

## 📋 プロジェクト概要

### 目的
中小企業向けの価格転嫁支援AIアシスタントを開発する。
価格転嫁を検討している事業者に対して、的確なアドバイスを提供するチャットボット。

### 最終形（ビジョン）
- 単なる質問応答型チャットボットではなく、ある程度フロー的に使えるもの
- ユーザーの状況をヒアリングし、価格転嫁プロセスのどこにいるのかを特定
- 特定したステップに応じたアドバイスを提供
- ユーザー企業の基本情報（業種、規模、地域など）に基づくパーソナライズ

### 現在の方針
- 一つのシステムプロンプトで全部やるのではなく、**ステップ判定後に追加プロンプトを動的に追加**
- ステップ判定は**質問の最初に自動で実行**（エージェントが手動でツールを呼び出す必要なし）
- ユーザー情報プロンプトも動的に追加（業種や規模に応じた具体的なアドバイス）
- UIのサイドバーは不要
- 判定されたステップに応じて、特定のツールを推奨・使用する

---

## 🎯 対象となる価格転嫁プロセス

中小企業庁が定義する価格転嫁プロセスに沿って支援を行う。

### STEP 0: 価格交渉準備編

価格交渉を行う前の準備段階。以下の9つのCHECKポイントを確認する。

| CHECK | 内容 | Good Practice |
|-------|------|--------------|
| **CHECK 1** | 取引条件・業務内容の確認 | 自社の業務フローと見積チェックリストを作成し、仕様の不確定要素の事前確認に活用 |
| **CHECK 2** | 原材料費・労務費データの定期収集 | 原材料費や労務費のデータは業界誌や公的サイトで定期的にチェック |
| **CHECK 3** | 原価計算の実施 | 支援機関やインターネットなどを活用して学習し、自社の主な事業の製品・サービスの原価計算を実施 |
| **CHECK 4** | 単価表の作成 | 自社の主な事業の製品・サービスの単価表を作成しておくと、価格交渉に役立つ |
| **CHECK 5** | 見積書フォーマットの整備 | 自社の特徴をふまえた見積書を用いて、見積チェックリストの不確定要素の明記等を行い価格交渉に活用 |
| **CHECK 6** | 取引先の経営方針・業績把握 | 取引先の動向把握は交渉スピードに影響。直接把握できない場合、業界団体などを活用し情報収集 |
| **CHECK 7** | 自社の付加価値の明確化 | 差別化が原価把握、取引先との交渉では重要。自社付加価値の見直しが必要 |
| **CHECK 8** | 適正な取引慣行の確認 | 適用対象が拡大され、一方的な代金決定の禁止等の禁止行為が追加。取引内容の確認が必要 |
| **CHECK 9** | 価格転嫁の必要性判定 | コスト高騰の影響を分析し、価格転嫁が必要かどうかを判定。営業利益が赤字になっているかを調査 |

### STEP 1〜5: 価格交渉実践編

準備が整った後の実際の価格交渉プロセス。

| STEP | 内容 | Good Practice |
|------|------|--------------|
| **STEP 1** | 業界動向の情報収集 | 自社の所属する業界団体などを通じ、業界動向を把握 |
| **STEP 2** | 取引先情報収集と交渉方針検討 | 発注側企業の事業形態や業種、規模などの動向と、自社との取引実績をふまえ交渉方針を検討 |
| **STEP 3** | 書面での申し入れ | 必要に応じて、書面での申し入れを行う |
| **STEP 4** | 説明資料の準備 | ①交渉に迅速・的確に対応できるよう、原材料費や労務費のデータは定期収集し備える<br>②現行商品・サービスの価格交渉だけでなく、自社の付加価値を活かした代替案提示が取引継続のポイント |
| **STEP 5** | 発注後の価格交渉 | ①アウトプットイメージの共有が困難か短期業務ほどプロセス管理を重視し、随時顧客等に進行確認を<br>②受注後に問題が生じ、価格交渉が必要な場合はスピード重視で顧客相談を |

---

## 🏗️ システムアーキテクチャ

### ファイル構成

```
SME-Agency-Price-Transfer-Support-AI/
├── api/                            # FastAPIバックエンド
│   └── main.py                    # APIサーバー（エントリポイント）
│
├── frontend/                       # React + TypeScriptフロントエンド
│   ├── src/
│   │   ├── App.tsx                # メインコンポーネント
│   │   ├── App.css                # スタイル
│   │   ├── main.tsx               # エントリーポイント
│   │   └── index.css              # グローバルスタイル
│   ├── package.json               # フロントエンド依存パッケージ
│   ├── tsconfig.json              # TypeScript設定
│   └── vite.config.ts             # Vite設定
│
├── agent/                          # エージェントロジック
│   ├── __init__.py
│   ├── core.py                    # エージェント初期化・実行ロジック
│   └── prompts.py                 # システムプロンプト定義
│
├── tools/                          # ツール
│   ├── __init__.py
│   ├── web_search.py              # Web検索ツール（AI信頼性判定付き）
│   ├── knowledge_base.py          # Knowledge Base検索ツール
│   ├── step_detector.py           # ステップ自動判定ツール
│   ├── diagram_generator.py       # 図生成ツール
│   └── cost_analysis.py           # 価格転嫁検討ツール（コスト分析）
│
├── docs/                           # ドキュメント
│   ├── REQUIREMENTS.md            # 要件定義書（本ファイル）
│   └── ARCHITECTURE.md            # アーキテクチャ設計書
│
├── diagrams/                       # 生成された図の保存先
├── app.py                          # Streamlit版（旧版、非推奨）
├── requirements.txt               # Python依存パッケージ
└── utils/
    └── __init__.py
```

### 技術スタック

- **フロントエンド**: React 18 + TypeScript + Vite
- **バックエンド**: FastAPI (Python)
- **エージェントフレームワーク**: Strands Agents
- **LLM**: AWS Bedrock - Claude Haiku 4.5 (`jp.anthropic.claude-haiku-4-5-20251001-v1:0`)
  - Region: ap-northeast-1
  - Temperature: 0.7
  - Max tokens: 50000
  - Streaming: 有効（Server-Sent Events）
- **検索**:
  - Tavily API (Web検索)
  - AWS Bedrock Knowledge Base (ナレッジベースID: `7SM8UQNQFL`)
- **図生成**: matplotlib (Pythonサブプロセスで実行)
- **ストリーミング**: Server-Sent Events (SSE)

---

## 🔧 実装済み機能

### 1. ユーザー情報入力機能 ✅

**起動時のモーダル入力:**
- 業種（製造業、建設業、小売業など）
- 主な製品・サービス
- 従業員規模（1-5人、6-20人など）
- 地域（都道府県）
- 取引先の主な業種
- 現在の価格転嫁の状況（検討中、準備中など）

**パーソナライズ:**
- ユーザー情報に基づくシステムプロンプトの動的生成
- 業種や規模に応じた具体的なアドバイス
- ウェルカムメッセージのカスタマイズ

### 2. チャット機能 ✅

- React + TypeScriptを使用したモダンなチャットUI
- ストリーミング応答（Server-Sent Eventsでリアルタイムテキスト生成）
- Markdownレンダリング（react-markdown + remark-gfm）
- チャット履歴の保存・表示
- 履歴クリア機能
- 応答の停止機能（AbortController使用）
- テキストエリアの自動高さ調整
- レスポンシブデザイン対応

### 3. ツール機能

#### `web_search` (Tavily API + AI信頼性判定)
- Web検索を実行
- **AIによる動的な信頼性判定**: 各検索結果をClaude Haikuが評価
- 信頼できる公的機関（政府機関、自治体、支援機関、企業サイト、メディアなど）のソースのみ表示
- 個人ブログやアフィリエイトサイトは自動除外
- ソース種別を表示（政府機関/公的機関/学術機関/業界メディア/ニュースメディア/データ提供サイト/業界団体/企業サイト）
- 最大5件の検索結果を取得
- AI要約機能付き
- **リトライロジック**: レート制限エラー時に指数バックオフで最大5回リトライ

#### `search_knowledge_base` (AWS Bedrock KB)
- ナレッジベースから価格転嫁関連情報を検索
- セマンティック検索（ベクトル検索）
- 最大5件の結果を取得
- 出典ファイル名とスコアを表示
- S3ロケーションから元ファイルを特定
- **リトライロジック**: レート制限エラー時に指数バックオフで最大5回リトライ

#### `detect_current_step` (LLMベースステップ判定)
- ユーザーの質問から価格転嫁プロセスのステップを自動判定
- STEP 0 (CHECK 1〜9) および STEP 1〜5 に対応
- Claude Haikuを使用した高精度判定
- 判定理由と信頼度（high/medium/low）を返却
- 詳細なデバッグログ機能
- 会話の文脈を考慮した判定
- **リトライロジック**: レート制限エラー時に指数バックオフで最大5回リトライ
- **重要**: バックエンドで質問の最初に自動実行（エージェントが手動で呼び出す必要なし）

#### `analyze_cost_impact` (価格転嫁検討ツール)
- **使用場面**: STEP 0 - CHECK 9（価格転嫁の必要性判定）
- コスト高騰の影響を分析し、価格転嫁の必要性を判定
- 入力データ:
  - コスト高騰前: 売上高、売上原価、販管費・その他経費
  - 現在: 売上高、売上原価、販管費・その他経費
- 分析内容:
  - 利益率の変化を計算
  - 各コスト項目の増減率・増減額を計算
  - コスト高騰前の利益率を維持するための参考価格を算出
  - 価格転嫁の必要性を判定
- **フロントエンドモーダル**: STEP 9の際に「📊 価格転嫁検討ツールで分析する」ボタンを表示
- **自動図生成**: 分析結果に基づいて棒グラフを自動生成

#### `generate_diagram` (図生成)
- 4種類の図に対応: 棒グラフ、折れ線グラフ、フローチャート、ネットワーク図
- description からデータを自動抽出（JSON形式、テーブル形式、リスト形式に対応）
- 生成された図は `diagrams/` フォルダに保存
- セッションに紐づく図のみ表示（セッション作成時刻以降の図）
- UI上で最新の図を自動表示（アシスタントメッセージの直後）
- 日本語フォント対応（Windows/macOS/Linux）
- matplotlibコードを自動生成してサブプロセスで実行

#### `calculator`
- 基本的な計算機能（Strands標準ツール）

#### `current_time`
- 現在時刻を取得（Strands標準ツール）

### 4. セッション管理

- UUID-based のセッションID生成（8文字）
- セッション状態の管理:
  - `session_id`: セッションID
  - `messages`: 会話履歴
  - `agent`: エージェントインスタンス
  - `current_step`: 判定されたステップ（例: "STEP_0_CHECK_3"）
  - `user_info`: ユーザー企業の基本情報
  - `created_at`: セッション作成時刻（図のフィルタリングに使用）
- FastAPIのメモリ上でセッション管理（再起動でリセット）

### 5. アーキテクチャの分離

- **フロントエンド**（`frontend/`）: React + TypeScript UI
- **バックエンド**（`api/main.py`）: FastAPI REST API + SSEストリーミング
- **エージェントロジック**（`agent/core.py`）: エージェント初期化・実行・ステップ更新
- **システムプロンプト**（`agent/prompts.py`）: プロンプト定義（基本 + ステップ別）
- **ツール**（`tools/`）: 各種ツール実装

### 6. APIエンドポイント

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/` | GET | ヘルスチェック |
| `/api/session` | POST | セッション作成（ユーザー情報付き） |
| `/api/session/{id}/messages` | GET | メッセージ履歴取得 |
| `/api/session/{id}/clear` | POST | セッションクリア |
| `/api/chat` | POST | チャットメッセージ送信（SSEストリーミング） |
| `/api/diagrams/latest` | GET | 最新の図取得（セッションに紐づく） |
| `/api/diagrams/{filename}` | GET | 図ファイル取得 |
| `/api/cost-analysis` | POST | コスト分析実行 |

---

## 🎯 実装済み機能（詳細）

### Phase 1: ステップ自動判定機能 ✅

**実装済み:**
- ユーザーの質問内容から、価格転嫁プロセスのどのステップにいるかを自動判定
- 判定後、そのステップに特化したアドバイスを提供

**実装内容:**
1. **質問の最初に自動実行**（バックエンドで実施）
   - `POST /api/chat` リクエスト受信時、エージェント実行前にステップ判定を実行
   - `detect_current_step` ツールを会話の文脈とともに呼び出し
   - 判定結果（step, confidence, reasoning）をSSEイベント（`step_update`）で送信

2. **セッション状態を更新 & エージェント再初期化**
   - セッション状態（`current_step`）を更新
   - エージェントを新しいステップ用のプロンプトで再初期化
   - 新しいプロンプト = 基本プロンプト + ユーザー情報プロンプト + ステップ別プロンプト

3. **フロントエンドでステップ表示**
   - SSEイベント（`step_update`）を受信
   - 画面上部にステップ表示（例: "📌 価格交渉準備編 - 原価計算の実施"）
   - ステップ名をユーザー向けに変換（`formatStepName`関数）

**動作例:**
```
ユーザー: 「原価計算のやり方を教えて」
↓
バックエンド: [質問の最初に detect_current_step を自動実行]
↓
AI判定: {"step": "STEP_0_CHECK_3", "confidence": "high", "reasoning": "原価計算について質問"}
↓
バックエンド: [セッション状態を更新 & エージェント再初期化]
↓
バックエンド: [SSEイベント step_update を送信]
↓
フロントエンド: [ステップ表示を更新]「📌 価格交渉準備編 - 原価計算の実施」
↓
エージェント: [CHECK 3用プロンプトで回答生成]
「原価計算の実施について、詳しくご説明します...」
```

### Phase 2: ステップ別のツール推奨 ✅

**実装済み:**
- 判定されたステップに応じて、特定のツールを積極的に使用するよう推奨

**実装内容:**
- `agent/prompts.py` にステップ別の追加プロンプトを定義済み（`STEP_CONTEXT`辞書）
- 各ステップごとに「推奨ツール」と「使用指示」を記載
- エージェントはこの指示に従って自動的にツールを使用

**例（CHECK 3の場合）:**
```python
"STEP_0_CHECK_3": """
【現在のフォーカス】STEP 0 - CHECK 3: 原価計算の実施

## このステップで推奨されるツール（必ず使用）
1. **まず `search_knowledge_base` で「原価計算」を検索**（必須）
2. `calculator`: 原価計算のシミュレーション
3. `generate_diagram`: 原価構造の可視化（円グラフ、棒グラフ）

## 回答時の注意
- Knowledge Baseの情報を基に、具体的な手順を説明すること
- 自分の知識だけで回答しないこと
"""
```

**例（CHECK 9の場合）:**
```python
"STEP_0_CHECK_9": """
【現在のフォーカス】STEP 0 - CHECK 9: 価格転嫁の必要性判定

## 【最重要】価格転嫁検討ツールの積極的な使用

**このステップでは、価格転嫁の必要性を判断するために、必ず `analyze_cost_impact` ツール（価格転嫁検討ツール）を使用してください。**

### 使用方針
1. **ユーザーが「価格転嫁するべきか分からない」「価格転嫁が必要か判断したい」などと言った場合**
   - 長々と質問をせず、**まず価格転嫁検討ツールの使用を積極的に推奨すること**
   - 「価格転嫁検討ツールを使って、数値に基づいた客観的な分析を行いましょう」と提案する

2. **ツールの実行**
   - ユーザーが数値を提供した場合、またはツールの使用に同意した場合、すぐに `analyze_cost_impact` ツールを呼び出すこと
   - ツールを呼び出すと、フロントエンドにモーダルが自動表示され、ユーザーが数値を入力できるようになります

3. **分析結果の図示**
   - **必須**: 価格転嫁検討ツールの分析結果を受け取った場合、必ず `generate_diagram` ツールを使用してグラフを生成すること
   - 分析結果に「【図示用データ】」が含まれている場合、そのデータを使って `generate_diagram` を呼び出すこと
"""
```

### Phase 3: ユーザー情報によるパーソナライズ ✅

**実装済み:**
- 起動時にユーザー企業の基本情報を入力
- ユーザー情報に基づくシステムプロンプトの動的生成

**実装内容:**
1. **ユーザー情報入力モーダル**（起動時）
   - 業種、製品・サービス、従業員規模、地域、取引先業種、価格転嫁状況を入力
   - 全項目任意入力（入力できる項目のみ記入）

2. **ユーザー情報プロンプトの動的生成**
   - `agent/core.py` の `_build_user_info_prompt()` メソッドでプロンプト生成
   - システムプロンプト = 基本プロンプト + ユーザー情報プロンプト + ステップ別プロンプト

3. **パーソナライズされたアドバイス**
   - 業種や規模に応じた具体的な事例や手法を提示
   - 地域の特性を考慮した情報提供
   - 現在の価格転嫁の状況に応じた適切なステップの提案

**例:**
```
## ユーザー企業の基本情報

- **業種**: 製造業
- **主な製品・サービス**: 金属加工部品
- **従業員規模**: 21-50人
- **地域**: 東京都
- **取引先の主な業種**: 自動車メーカー
- **現在の価格転嫁の状況**: 検討中

**重要**: 上記のユーザー企業の情報を踏まえて、より具体的で実践的なアドバイスを提供してください。
- 業種や規模に応じた具体的な事例や手法を提示
- 地域の特性を考慮した情報提供
- 現在の価格転嫁の状況に応じた適切なステップの提案
```

### Phase 4: 価格転嫁検討ツール ✅

**実装済み:**
- STEP 0 - CHECK 9専用の価格転嫁検討ツール
- フロントエンドモーダルでの入力
- 自動分析 + 図生成

**実装内容:**
1. **フロントエンドボタン表示**
   - STEP 9判定時、最新のアシスタントメッセージの下に「📊 価格転嫁検討ツールで分析する」ボタンを表示

2. **モーダル入力**
   - コスト高騰前: 売上高、売上原価、販管費・その他経費
   - 現在: 売上高、売上原価、販管費・その他経費

3. **分析実行**
   - `POST /api/cost-analysis` で分析実行
   - 利益率の変化、各コスト項目の増減率・増減額を計算
   - コスト高騰前の利益率を維持するための参考価格を算出
   - 価格転嫁の必要性を判定

4. **結果表示と図生成**
   - 分析結果をエージェントに送信（内部処理、ユーザーメッセージは表示しない）
   - エージェントが分析結果を要約 + `generate_diagram` で棒グラフを自動生成
   - フロントエンドで結果と図を表示

---

## 🔄 想定されるユーザーフロー

### 基本フロー（ステップ判定あり）

```
1. アプリケーション起動
   - ユーザー情報入力モーダル表示
   - 業種、製品・サービス、従業員規模などを入力
   - 「登録して開始」クリック

2. セッション作成
   - POST /api/session でセッション作成
   - ユーザー情報を含めてエージェント初期化
   - ウェルカムメッセージ表示（ユーザー情報に基づいてカスタマイズ）

3. ユーザーが質問を入力
   例: 「原価計算のやり方を教えて」

4. バックエンドで質問の最初にステップ判定を自動実行
   - detect_current_step ツールを呼び出し
   - AI判定: {"step": "STEP_0_CHECK_3", "confidence": "high", "reasoning": "原価計算について質問"}

5. セッション状態を更新 & エージェント再初期化
   - session["current_step"] = "STEP_0_CHECK_3"
   - エージェントに追加プロンプトを注入（基本 + ユーザー情報 + CHECK 3用）
   - SSEイベント step_update を送信

6. フロントエンドでステップ表示を更新
   - 「📌 現在のステップ: 価格交渉準備編 - 原価計算の実施」

7. エージェントがステップに特化したアドバイスを提供
   - CHECK 3の文脈を理解した詳しい回答
   - 推奨ツールを使用:
     a. search_knowledge_base("原価計算") → Knowledge Baseから手順を取得
     b. calculator → 原価計算のシミュレーション
     c. generate_diagram → 原価構造の可視化

8. フロントエンドで表示
   - Markdownレンダリング
   - 図があればアシスタントメッセージの直後に表示
```

### 価格転嫁検討ツールフロー（CHECK 9専用）

```
1. ユーザーが「価格転嫁が必要か判断したい」と質問

2. バックエンドでステップ判定
   - AI判定: {"step": "STEP_0_CHECK_9", "confidence": "high"}

3. エージェントが価格転嫁検討ツールの使用を推奨
   - 「価格転嫁検討ツールを使って、数値に基づいた客観的な分析を行いましょう」

4. フロントエンドに「📊 価格転嫁検討ツールで分析する」ボタンを表示

5. ユーザーがボタンをクリック
   - モーダルが開く

6. ユーザーがコスト高騰前・現在のデータを入力
   - 売上高、売上原価、販管費・その他経費

7. 「分析実行」クリック
   - POST /api/cost-analysis で分析実行

8. 分析結果をエージェントに送信（内部処理）
   - 分析結果 + 図示用データを含むメッセージ
   - ユーザーメッセージは表示しない（skipUserMessage = true）

9. エージェントが分析結果を要約 + generate_diagram で図生成
   - コスト高騰前と現在の比較グラフを作成

10. フロントエンドで結果と図を表示
    - 分析結果の要約
    - 棒グラフ（売上高、売上原価、販管費、総コスト、利益の比較）
```

---

## 📊 データフロー

### セッション管理

**バックエンド（FastAPI）:**
```python
sessions[session_id] = {
    "session_id": str,                # ランダムなUUID（8文字）
    "messages": list,                 # 会話履歴
    "agent": PriceTransferAgent,      # エージェントインスタンス
    "current_step": str | None,       # 判定されたステップ (例: "STEP_0_CHECK_3")
    "user_info": dict | None,         # ユーザー企業の基本情報
    "created_at": float               # セッション作成時刻（UNIX timestamp）
}
```

**フロントエンド（React）:**
```typescript
const [sessionId, setSessionId] = useState<string | null>(null)
const [messages, setMessages] = useState<Message[]>([])
const [currentStep, setCurrentStep] = useState<string | null>(null)
const [userInfo, setUserInfo] = useState<UserInfo>({})
const [latestDiagram, setLatestDiagram] = useState<string | null>(null)
const [diagramMessageIndex, setDiagramMessageIndex] = useState<number | null>(null)
```

### エージェントの初期化・更新

```python
# 初期化（ユーザー情報付き）
agent = PriceTransferAgent(
    current_step=None,
    user_info={"industry": "製造業", "products": "金属加工部品", ...}
)

# ステップ判定後に更新
agent.update_step("STEP_0_CHECK_3")
# → 内部でシステムプロンプトが再構成され、エージェントが再初期化される
# → 新しいプロンプト = 基本 + ユーザー情報 + CHECK 3用
```

### SSEイベントフロー

**バックエンド → フロントエンド:**

| イベントタイプ | 説明 | データ例 |
|-------------|------|---------|
| `status` | ステータス更新（思考中、検索中など） | `{"type": "status", "status": "thinking", "message": "思考中..."}` |
| `content` | テキストチャンク（ストリーミング） | `{"type": "content", "data": "原価計算について..."}` |
| `tool_use` | ツール使用中（モーダル表示の場合もあり） | `{"type": "tool_use", "tool": "analyze_cost_impact", "show_modal": true}` |
| `step_update` | ステップ更新 | `{"type": "step_update", "step": "STEP_0_CHECK_3", "confidence": "high", "reasoning": "..."}` |
| `done` | 完了 | `{"type": "done", "content": "..."}` |
| `error` | エラー | `{"type": "error", "error": "エラーメッセージ"}` |

---

## 🎨 UI要件

### 現在のUI（React版）

**レイアウト:**
- ヘッダー: 「価格転嫁支援AIアシスタント」 + 履歴クリアボタン
- ステップ表示（現在のステップを表示、判定されている場合のみ）
- チャットエリア（会話履歴表示）
- テキスト入力欄（複数行対応、Shift+Enterで改行）
- 送信ボタン / 停止ボタン
- 生成された図の自動表示（アシスタントメッセージの直後）

**モーダル:**
1. **ユーザー情報入力モーダル**（起動時）
   - 業種、製品・サービス、従業員規模、地域、取引先業種、価格転嫁状況
   - 「登録して開始」ボタン

2. **価格転嫁検討ツールモーダル**（STEP 9の際）
   - コスト高騰前・現在のデータ入力
   - 「分析実行」ボタン / 「キャンセル」ボタン

### 表示要素

- **ストリーミング応答**:
  - Server-Sent Eventsでリアルタイムテキスト生成
  - カーソル表示（▌）

- **ステータス表示**:
  - 思考中: "思考中..."
  - 検索中: "検索中..."
  - 図を生成中: "図を生成中..."
  - コスト分析中: "コスト分析中..."

- **ステップ表示**:
  - 画面上部に現在のステップを表示
  - 例: "📌 現在のステップ: 価格交渉準備編 - 原価計算の実施"
  - ステップ名はユーザー向けに変換（`formatStepName`関数）

- **図の表示**:
  - セッションに紐づく最新の図を自動取得・表示
  - アシスタントメッセージの直後に表示

- **価格転嫁検討ツールボタン**:
  - STEP 9の際、最新のアシスタントメッセージの下に表示
  - 「📊 価格転嫁検討ツールで分析する」

### 技術的実装

- React 18 + TypeScript
- Vite（開発サーバー、HMR対応）
- react-markdown + remark-gfm（Markdownレンダリング、GFM対応）
- Server-Sent Events（ストリーミング）
- Axios（HTTP通信）
- AbortController（応答の停止機能）

---

## 🔒 制約・考慮事項

### 技術的制約

- 図生成はPythonサブプロセスで実行（タイムアウト30秒）
- セッション状態はFastAPIのメモリ上のみ（永続化なし、再起動でリセット）
- 複数ユーザー同時利用時はセッションIDで分離
- バックエンドとフロントエンドは別々のプロセスで起動
- CORS設定が必要（開発環境: localhost:5173, localhost:3000）
- レート制限エラー時の自動リトライ（指数バックオフ、最大5回）

### UX考慮事項

- 価格転嫁は長期プロセスのため、すぐに最初から最後まで進めるものではない
- ユーザーは途中のステップから開始することもある
- ステップを強制せず、自由な質問も可能にする柔軟性が必要
- ステップ判定は「推奨」であって「制約」ではない

### セキュリティ考慮事項

- Web検索結果のAI信頼性判定（個人ブログやアフィリエイトサイトを自動除外）
- Knowledge Baseの情報を最優先で使用
- 自分の事前学習知識だけで回答しない

---
