# 中小企業よろず相談 & 価格転嫁支援AI - 要件定義書

## 📋 1. プロジェクト概要

### 目的
中小企業経営者のあらゆる悩みを受け止める「よろず相談」から始まり、課題が「価格転嫁」と特定された瞬間に、**最強の専門ツールを備えた「実行支援モード」**へとシームレスに移行するAIエージェントシステム。
単なる相談相手ではなく、**「共に戦う参謀」**として、データ収集、資料作成、交渉戦略の立案までを完遂させることを目的とする。

### コアコンセプト：2段階モード・エージェントシステム
ユーザーの対話深度と課題の緊急度に応じて、システムの振る舞いと使用可能なツールセットを動的に、かつ劇的に切り替える。

1.  **Mode 1: よろず相談モード (General Consultant)**
    *   **目的**: 経営課題の広範な探索と、真の課題（ボトルネック）の特定。
    *   **機能**: 傾聴、状況整理、メンタルケア、幅広い経営アドバイス（資金繰り、人材、販路拡大、事業承継など）。
    *   **Web検索機能**: **標準搭載**。最新の市場動向、業界ニュース、統計データなどをリアルタイムで取得可能。
    *   **スタンス**: 親身な聞き手、良き理解者。
    *   **モデル**: Claude 4.5 Haiku
    *   **ゴール**: 課題が「価格転嫁」にあるか否かの明確な切り分け。

2.  **Mode 2: 価格転嫁専門モード (Price Transfer Specialist)**
    *   **目的**: **価格交渉の完全勝利**と、適正利益の確保による経営基盤の強化。
    *   **機能**: 専門的市場分析、精緻なコスト計算、プロフェッショナルな法的文書作成、高精度な交渉シミュレーション。
    *   **動作の仕組み（重要）**:
        1. **6つの専門ツールを直接使用可能**: LLMがFunction Callingで必要なツールを直接呼び出し
        2. **柔軟なツール選択**: 会話内容に応じてLLMが最適なツールを判断・実行
        3. **シームレス実行**: ユーザーは対話を続けるだけで、裏側で専門ツールが連携動作し、最適な支援を提供
    *   **スタンス**: 頼れる軍師、冷徹な分析官、熱意ある交渉パートナー。
    *   **モデル**: Claude 4.5 Haiku
    *   **指針**: 中小企業庁のガイドラインおよび「Good Practice」を徹底的に遵守しつつ、**「勝てる」**論理を構築する。
    *   **参考プレイブック**: CHECK 1-9（準備編）、STEP 1-5（実践編）の14ステップを参考ガイドラインとして提供（順番の強制なし）

---

## 🧠 2. 3層エージェントアーキテクチャ

本システムは**3つのエージェント**が協調動作する階層構造を採用する。

### 2.1 Orchestrator Agent（親エージェント・司令塔）

**役割:** 毎回の受け口として、モード判定と適切なエージェントへの振り分けを担当

**責務:**
- ユーザー入力を毎回受け取る（全リクエストの入り口）
- モード判定（Mode 1 or Mode 2）
- モード切り替え処理とユーザー承諾管理
- セッション状態の更新
- 適切な子エージェント（Mode 1 / Mode 2 Agent）への委譲

**判定方式:**
- **キーワードベース判定**: 「値上げ」「価格転嫁」「コスト増」「買いたたき」「下請法」等
- **軽量LLM推論**: キーワードで判定できない場合のみ、LLMに問い合わせ（最小トークン）
- **判定頻度**: 毎回（全リクエスト）

**モード切り替えフロー:**
1. Mode 1 → Mode 2: ユーザー承諾を求める
2. Mode 2 → Mode 1: 自動で切り替え（話題が変わった場合）
3. Mode 2の進捗データは保持され、再度Mode 2に戻った際に復元

**特性:** ステートレス（状態を持たない）。判定だけを行い、ビジネスロジックは持たない。

---

### 2.2 Mode 1 Agent（よろず相談エージェント）

**役割:** 一般的な経営相談に対応する汎用エージェント

**機能:**
- 傾聴、状況整理、メンタルケア
- 幅広い経営アドバイス（資金繰り、人材、販路拡大等）
- Web検索機能（標準搭載）

**使用ツール:**
- Web Search API（市場動向・ニュース検索）

**出力:**
- 価格転嫁キーワードを検知した場合、Orchestratorへ報告

---

### 2.3 Mode 2 Agent（価格転嫁専門エージェント）

**役割:** 価格転嫁に特化した専門エージェント。6つの専門ツールを直接使用して支援を提供。

**責務:**
- **ツール直接実行**: LLMがFunction Callingで6つの専門ツールを直接呼び出し
- **柔軟な対応**: ユーザーの要望に応じて最適なツールを判断・実行
- **成果物管理**: 生成されたグラフ、文書、試算表などをセッションに紐付けて保存
- **ガイドライン提供**: 14ステップ（CHECK 1-9, STEP 1-5）を参考情報として提示

**ツール使用方式:**
- **入力情報**: ユーザーの発言、会話履歴、ユーザー属性データ
- **判断ロジック**: LLMが会話内容から必要なツールを直接判断
- **実行**: Function Callingで該当ツールを呼び出し
- **柔軟性**: ユーザーは自由にツールを使用可能（順番の制約なし）

**ツール直接呼び出しの例:**
- ユーザー: 「取引先の財務状況を知りたい」
  - Mode 2 Agent: `company_research`ツールを直接呼び出し
- ユーザー: 「いくら値上げすればいいか分からない」
  - Mode 2 Agent: `analyze_cost_impact`ツールを直接呼び出し
- ユーザー: 「原材料の価格推移を調べて」
  - Mode 2 Agent: `market_analysis`ツールを直接呼び出し

**特性:** 会話履歴をセッションで保持。モード切り替え後も会話コンテキストを復元可能。

---

### 2.4 セッション管理と記憶の継続性

**セッション構造:**
```python
Session {
    session_id: str          # セッションID
    mode: str                # 現在のモード（"mode1" or "mode2"）
    history: List[Message]   # 全会話履歴（全モード共通）
    generated_files: list    # 生成されたファイル（グラフ、文書等）
}
```

**記憶の継続:**
- 会話履歴は全モード共通で保持される
- Mode 1に切り替えても、会話履歴は消えない
- Mode 2に戻った際、前回の会話コンテキストから再開可能

**実装パターン（段階的）:**
1. **プロトタイプ**: LLMコンテキストのみ（ストレージ不要）
2. **MVP**: インメモリストレージ（グローバル変数）
3. **本番環境**: ファイルシステム or Redis or DynamoDB

**ユーザー体験:**
```
ユーザー: 「原価計算したい」
→ Mode 2 Agent: analyze_cost_impactツールを実行

ユーザー: 「人材採用で困ってて...」
→ Mode 1に切り替え

ユーザー: 「価格転嫁に戻りたい」
→ Mode 2に戻る
→ Mode 2 Agent: 「先ほどの原価計算の続きですね。他に分析したいことはありますか？」
```

---

## 🛠️ 3. 6つの専門ツール詳細仕様（Mode 2専用）

本モードで使用可能なツールは、プロフェッショナルなコンサルタントが使用するレベルの高度な機能を、誰でも直感的に扱えるように設計されている。
これらのツールは単独でも強力だが、組み合わせることで「証拠収集→分析→戦略立案→資料作成→交渉実行」という一連のバリューチェーンを完全自動化する。

### ツール設計思想
*   **最小公倍数の原則**: 各ツールは単一の明確な責務を持ち、組み合わせで高度な機能を実現
*   **LLMとの協調**: ツールは実行が必要な部分のみを担当し、判断・解釈はLLMが行う
*   **Zero Learning Curve**: 専門知識がなくても、対話だけで最適な分析・資料が手に入る
*   **Evidence-Based**: すべての主張に「出典」と「計算根拠」を付与し、反論を許さない
*   **Actionable Output**: 「参考になりました」で終わらせない。即座に使える成果物（ファイル、文書、スクリプト）を出力する

---

### ① `web_search` (Web検索ツール)
*   **概要**: あらゆる外部情報取得の基盤。市場データ、企業情報、業界ニュースを検索。
*   **責務**: Web検索を実行し、構造化された検索結果を返す（結果の解釈・分析はLLMが担当）
*   **入力**:
    *   `query`: 検索クエリ（例: "企業物価指数 ステンレス 推移"、"A社 決算短信 2024"）
    *   `search_type`: "news" | "statistics" | "company_info" | "market_data"（オプション）
    *   `date_range`: 検索期間（オプション）
*   **出力**:
    ```json
    {
      "results": [
        {
          "title": "企業物価指数 2024年12月",
          "url": "https://...",
          "snippet": "鉄鋼は前年比+15.3%...",
          "published_date": "2024-12-01",
          "source": "日本銀行"
        }
      ],
      "metadata": {"query": "...", "result_count": 10}
    }
    ```
*   **LLMの役割**:
    *   検索結果から必要な数値データを抽出（価格指数、成長率、財務数値等）
    *   企業情報を分析してランク付け（S/A/B/C）
    *   業界動向を解釈して交渉戦略を提案
*   **使用例**:
    *   「原材料の価格推移を調べて」→ LLMが適切なクエリで`web_search`を実行
    *   「取引先の財務状況を知りたい」→ LLMが決算情報を検索・分析
    *   「業界の値上げ動向は？」→ LLMが業界ニュースを収集・整理
*   **技術スタック**: Web Search API, Requests
*   **使用タイミング**: CHECK 2（市場データ）, CHECK 6（取引先調査）, STEP 1（業界動向）

---

### ② `search_knowledge_base` (法務知識検索ツール)
*   **概要**: 下請法、独占禁止法、各種ガイドラインを網羅した「ポケットの中の法務部」。
*   **責務**: RAGベースの知識検索。法的根拠、計算式、事例を取得（法的解釈・適用判断はLLMが担当）
*   **知識ベース（RAG）**: S3 + Vector Search で、以下のデータを事前登録:
    *   下請代金支払遅延等防止法（下請法）全文
    *   独占禁止法 関連条文
    *   価格転嫁円滑化施策ハンドブック（中小企業庁）
    *   労務費の適切な転嫁のための価格交渉に関する指針
    *   公正取引委員会 勧告事例集
    *   原価計算の基礎（業種別モデル）
*   **入力**:
    *   `query`: 検索クエリ（例: "買いたたき 判定基準"、"労務費転嫁 計算式"）
    *   `category`: "law" | "guideline" | "case_study" | "calculation_formula"（オプション）
    *   `top_k`: 取得件数（デフォルト: 5）
*   **出力**:
    ```json
    {
      "results": [
        {
          "content": "下請法第4条第1項第5号により...",
          "source": "下請法第4条",
          "relevance_score": 0.95,
          "metadata": {"document": "下請法全文", "section": "第4条"}
        }
      ]
    }
    ```
*   **LLMの役割**:
    *   取得した条文をユーザーの状況に適用
    *   違法性の判定と説明
    *   対抗話法の生成（法的根拠付き）
*   **使用例**:
    *   「これって買いたたきですか？」→ LLMが関連条文を検索し、状況に適用して判定
    *   「値上げの計算式を知りたい」→ LLMが指針の計算式を取得・解説
    *   「過去の事例は？」→ LLMが類似事例を検索し、適用可能性を判断
*   **技術スタック**: RAG (S3 + Vector Search), FAISS/Pinecone, LangChain
*   **使用タイミング**: CHECK 3（計算式参照）, CHECK 8（法令違反チェック）, 随時

---

### ③ `calculate_cost_impact` (コスト影響試算ツール)
*   **概要**: 自社の経営を守るために**「絶対に譲れないライン」**を数学的に算出する、本システムの心臓部。
*   **責務**: 複雑な数値計算・シミュレーションを実行（計算結果の解釈・提案はLLMが担当）
*   **入力**:
    ```json
    {
      "current_cost_structure": {
        "material_cost": {"ratio": 0.40, "amount": 1000000},
        "labor_cost": {"ratio": 0.35, "amount": 875000},
        "energy_cost": {"ratio": 0.10, "amount": 250000},
        "overhead": {"ratio": 0.15, "amount": 375000}
      },
      "price_changes": {
        "material_cost": 0.20,  // +20%
        "labor_cost": 0.05,     // +5%
        "energy_cost": 0.30     // +30%
      },
      "target_profit_margin": 0.08  // オプション
    }
    ```
*   **出力**:
    ```json
    {
      "current_total_cost": 2500000,
      "new_total_cost": 2725000,
      "cost_increase": 225000,
      "cost_increase_rate": 0.09,
      "scenarios": {
        "premium": {"price_increase_rate": 0.15, "new_profit_margin": 0.12},
        "standard": {"price_increase_rate": 0.10, "new_profit_margin": 0.08},
        "minimum": {"price_increase_rate": 0.05, "new_profit_margin": 0.03}
      },
      "breakeven_analysis": {...},
      "calculation_details": "...",
      "legal_basis": "労務費転嫁指針 第3条..."
    }
    ```
*   **詳細機能**:
    *   **損益分岐点シミュレーション**: 赤字転落時期、利益減少額を試算
    *   **3段階価格設定（松・竹・梅）**: 理想/妥当/最低防衛ラインを算出
    *   **指針準拠フォーミュラ**: 公的計算式を完全実装
    *   **What-If分析**: 複数シナリオの並行試算
    *   **キャッシュフロー影響試算**: 月次改善額の算出
*   **LLMの役割**:
    *   計算結果の解釈と説明
    *   どのシナリオを推奨すべきかの判断
    *   計算ロジックをユーザーに分かりやすく説明
*   **使用例**:
    *   「いくら値上げすればいい？」→ LLMが原価情報をヒアリング後、本ツールで試算
    *   「赤字にならないラインは？」→ LLMが損益分岐点を計算・説明
*   **技術スタック**: NumPy, Pandas, Excel出力（openpyxl）
*   **使用タイミング**: CHECK 3, CHECK 9（最重要）

---

### ④ `generate_chart` (グラフ生成ツール)
*   **概要**: データを視覚化し、交渉の場で即座に使える高品質グラフを生成。
*   **責務**: データを受け取りグラフ画像を生成・保存（グラフの種類選択・データ解釈はLLMが担当）
*   **入力**:
    ```json
    {
      "data": {
        "time_series": [
          {"date": "2021-01", "value": 100},
          {"date": "2022-01", "value": 115},
          {"date": "2023-01", "value": 145}
        ]
      },
      "chart_type": "line",  // "line" | "bar" | "comparison" | "forecast"
      "title": "ステンレス価格指数の推移",
      "x_label": "年月",
      "y_label": "価格指数（2020年=100）",
      "annotations": [{"x": "2023-01", "text": "+45%"}]  // オプション
    }
    ```
*   **出力**:
    ```json
    {
      "image_url": "s3://bucket/session123/chart_001.png",
      "image_format": "png",
      "image_size": {"width": 800, "height": 600},
      "summary": "過去3年で原材料費が45%上昇している傾向"
    }
    ```
*   **LLMの役割**:
    *   `web_search`や`calculate_cost_impact`の結果からグラフ用データを抽出
    *   適切なグラフタイプを選択（折れ線/棒/比較/予測）
    *   グラフの解釈と説明文を生成
*   **使用例**:
    *   「原材料の価格推移をグラフ化して」→ LLMが検索結果からデータ抽出→本ツールで可視化
    *   「コスト構成比を見せて」→ LLMが試算結果を円グラフ化
*   **技術スタック**: Matplotlib, Seaborn, S3 Storage
*   **使用タイミング**: CHECK 2（市場データ）, CHECK 9（コスト試算）, STEP 1（交渉資料）

---

### ⑤ `generate_document` (文書自動生成ツール)
*   **概要**: 交渉に必要な「武器（書類）」を、数秒で、プロフェッショナルなクオリティで作成。
*   **責務**: ビジネス文書のテンプレート処理・PDF/Excel生成・S3保存（文書内容の作成はLLMが担当）
*   **生成可能な文書タイプ**:
    *   `quotation`: コスト費目別見積書
    *   `request_letter`: 価格交渉申入書
    *   `negotiation_materials`: 価格改定説明資料（プレゼン資料）
    *   `agreement`: 合意書
    *   `cost_breakdown`: 原価内訳書
*   **入力**:
    ```json
    {
      "document_type": "request_letter",
      "tone": "friendly",  // "formal" | "friendly" | "assertive" | "urgent"
      "data": {
        "client_name": "株式会社A",
        "current_price": 10000,
        "new_price": 11000,
        "increase_rate": 0.10,
        "reason": "原材料費の高騰により...",
        "evidence": ["グラフURL", "試算表URL"]
      },
      "attachments": ["s3://chart_001.png", "s3://cost_analysis.xlsx"]
    }
    ```
*   **出力**:
    ```json
    {
      "document_url": "s3://bucket/session123/request_letter_001.pdf",
      "document_format": "pdf",
      "preview": "拝啓 時下ますますご清栄のこととお慶び申し上げます..."
    }
    ```
*   **詳細機能**:
    *   **トーン調整**: 関係性に応じて文体を4段階で調整
    *   **法的文言の自動挿入**: 下請法・独禁法の引用を適切に挿入
    *   **添付資料の統合**: グラフ・試算表を1つのPDFパッケージに統合
    *   **テンプレートエンジン**: Jinja2ベースのカスタマイズ可能なテンプレート
*   **LLMの役割**:
    *   文書の内容・論理構成を作成
    *   適切なトーンを判断
    *   法的根拠の引用箇所を指定
*   **使用例**:
    *   「申入書を作成して」→ LLMが内容を作成→本ツールでPDF生成
    *   「見積書をコスト費目別にして」→ LLMが内訳を整理→本ツールでExcel生成
*   **技術スタック**: Jinja2, python-docx, openpyxl, ReportLab (PDF), S3 Storage
*   **使用タイミング**: CHECK 1, 4, 5, STEP 3, 4, 5など（全ステップで活用）

---

### ⑥ `simulate_negotiation` (交渉シミュレーションツール)
*   **概要**: 本番で失敗しないためのロールプレイ訓練。AI相手の模擬戦で経験値を積む。
*   **責務**: 相手役のペルソナを管理し、スコアリング機能を提供（交渉内容・戦略はLLMが担当）
*   **入力**:
    ```json
    {
      "scenario": {
        "client_name": "A社",
        "negotiation_goal": "10%値上げ",
        "user_strengths": ["短納期対応", "高品質"],
        "client_characteristics": "増収増益、コスト削減志向"
      },
      "opponent_persona": "cost_focused",  // "aggressive" | "logical" | "collaborative" | "cost_focused"
      "user_response": "今回、原材料費の高騰により..."
    }
    ```
*   **出力**:
    ```json
    {
      "opponent_response": "確かに原材料は上がっていますが、うちも予算が厳しくて...",
      "feedback": {
        "score": 75,
        "logic_score": 80,
        "tone_score": 70,
        "evidence_usage_score": 75,
        "strengths": ["論理性が高い", "証拠を効果的に提示"],
        "improvements": ["もう少し協調的なトーンで", "相手の懸念に共感を示す"],
        "next_suggestion": "ここで具体的な数値データを提示しましょう"
      },
      "continue": true,
      "round": 3
    }
    ```
*   **詳細機能**:
    *   **ペルソナ設定**: 4種類の相手役を演じ分け
    *   **リアルタイムコーチング**: 発言に対する即座のフィードバック
    *   **スコアリング**: 論理性・協調性・証拠活用を採点
    *   **複数ラウンド対応**: 初回拒否→2回目交渉まで想定
*   **LLMの役割**:
    *   ペルソナに応じた相手役の発言生成
    *   ユーザーの交渉戦略を評価・改善提案
    *   想定問答集の生成
*   **使用例**:
    *   「交渉の練習をしたい」→ LLMがペルソナを確認→本ツールでロールプレイ開始
    *   「高圧的な相手への対応を練習したい」→ aggressiveペルソナで訓練
*   **技術スタック**: LLM (Multi-turn conversation), スコアリングエンジン
*   **使用タイミング**: CHECK 7（強みの言語化後）, STEP 4（交渉本番前）

---

## 🔄 ツール連携の実例

**「取引先A社への10%値上げ交渉準備」の自動フロー:**

1. **市場調査**: `web_search` → LLMが原材料価格推移を抽出
2. **グラフ化**: `generate_chart` → 価格推移グラフ生成
3. **取引先調査**: `web_search` → LLMが財務状況を分析・ランク付け
4. **コスト試算**: `calculate_cost_impact` → 松竹梅プラン生成
5. **法的根拠確認**: `search_knowledge_base` → LLMが計算式の正当性を確認
6. **交渉シナリオ作成**: LLMが戦略を立案
7. **文書生成**: `generate_document` → 申入書・見積書・説明資料を一括生成
8. **ロールプレイ訓練**: `simulate_negotiation` → 本番前のリハーサル

→ ユーザーは対話するだけで、完璧な交渉準備パッケージが完成

---

## 📖 4. 参考プレイブック（ガイドライン）

各ステップにおいて、ユーザーは何をすべきか、AIはどう支援すべきかを極限まで具体化したアクションプラン。
**これらのステップは強制ではなく、参考ガイドラインとして提供される。**
ユーザーは自由に必要なツールを使用でき、LLMが会話内容に応じて最適なツールを直接呼び出す。

### 🟢 §1 価格交渉準備編 (CHECK 1-9)
交渉のテーブルに着く前に、勝負の8割は決まっている。徹底的な準備で外堀を埋めるフェーズ。

#### CHECK 1: 取引条件・業務内容の完全可視化
*   **目的**: 契約の曖昧さを排除し、追加請求できる状態にする
*   **課題**: 口約束、曖昧な発注書、「一式」見積もりが横行し、どこまでが契約範囲かが不明確。これでは追加請求ができない。
*   **ゴール**: 契約のグレーゾーンを撤廃し、すべての業務をリスト化する。
*   **AI支援**:
    1.  現状ヒアリング: 「契約書はありますか？」「発注書と実作業に乖離はありませんか？」を徹底確認。
    2.  `document_generator`使用: 「業務フロー図」テンプレートを展開。ユーザーと共に業務の棚卸しを行い、サービス残業的なタスクをあぶり出す。
    3.  `document_generator`使用: 「見積チェックリスト」を作成し、次回からの受注時の必須確認事項を定める。

#### CHECK 2: 原材料費・労務費データの証拠化
*   **目的**: 「なんとなく上がった」を「客観的データ」に変換
*   **課題**: 「最近高い気がする」という感覚論では、交渉相手に鼻で笑われる。
*   **ゴール**: 公的統計データを味方につけ、反論不可能な事実を突きつける。
*   **AI支援**:
    1.  `market_analysis`使用: ユーザーの主要原材料（鉄、樹脂、食品等）を特定し、過去3年の価格推移データをWeb検索で取得。
    2.  `market_analysis`使用: 地域別最低賃金の推移データを取得し、労務費上昇の根拠とする。
    3.  視覚化: 上昇トレンドが一目でわかる「インパクト・グラフ」を作成し、ユーザーに提示。

#### CHECK 3: 精緻な原価計算の実施
*   **目的**: 製品1個あたりの正確なコスト構造を把握
*   **課題**: どんぶり勘定が染み付いており、製品1個あたりの正確なコスト構造が不明。
*   **ゴール**: 製品・サービス単位で「原価」と「利益」を1円単位で把握する。
*   **AI支援**:
    1.  `search_knowledge_base`使用: 業種に合わせた原価計算の基本モデル（簡易コース、詳細コース）を提示。
    2.  `analyze_cost_impact`使用: 対話形式で変動費（材料・外注）、固定費（人件費・家賃）を入力させ、配賦計算を実行。
    3.  分析: 採算割れしている製品（赤字製品）を特定し、優先交渉対象としてマークする。

#### CHECK 4: 戦略的単価表の作成
*   **目的**: 標準化された「自社定価」を持つ
*   **課題**: 案件ごとに都度見積もりを作っており、価格の整合性が取れていない。
*   **ゴール**: 誰に見せても恥ずかしくない、標準化された「自社定価」を持つ。
*   **AI支援**:
    1.  `document_generator`使用: 部品別、工程別、スキルレベル別（職人ランク等）の標準単価表フォーマットを提供。
    2.  最適化: 原価データに基づき、適正利益を乗せた「新・標準単価」を提案・策定。

#### CHECK 5: 「中身の見える」見積書フォーマットへの刷新
*   **目的**: コスト費目を明記し、価格転嫁の透明性を確保
*   **課題**: 「一式」見積もりは値上げ交渉の天敵。内訳が見えないと、どこが上がったか説明できない。
*   **ゴール**: コスト費目（材料費、加工費、配送費、管理費）を明記し、価格転嫁の透明性を確保する。
*   **AI支援**:
    1.  `document_generator`使用: 中小企業庁推奨の「コスト費目別見積書」テンプレートを出力。
    2.  ガイダンス: 既存の見積もりを新フォーマットに変換する作業をサポート。内訳の分解方法をアドバイス。

#### CHECK 6: 敵を知る（取引先の経営分析）
*   **目的**: 相手の「支払い能力」と「建前」を把握し、攻め筋を決める
*   **課題**: 相手の懐事情を知らずに交渉し、タイミングを誤る。または、相手の「嘘（儲かっていないふり）」を見抜けない。
*   **ゴール**: 相手の「支払い能力（実力）」と「建前（方針）」を把握し、攻め筋を決める。
*   **AI支援**:
    1.  `company_research`使用: 取引先の最新決算、ニュース、中期計画をWeb検索で調査。
    2.  分析: 「増収増益」「最高益更新」などのキーワードがあれば、強気交渉のサインとして通知。
    3.  チェック: 「パートナーシップ構築宣言」実施企業リストと照合。宣言企業なら、その公約を利用する戦略を立案。

#### CHECK 7: 自社の「代替不可能性」の言語化
*   **目的**: 「あなたじゃなきゃ困る」と思わせる強みを再定義
*   **課題**: 「他でも買える」と思われている。価格競争に巻き込まれている。
*   **ゴール**: 「あなたじゃなきゃ困る」と思わせる強み（短納期、品質、対応力）を再定義し、交渉カードにする。
*   **AI支援**:
    1.  深堀りインタビュー: 「他社が断る面倒な仕事を受けていませんか？」「不良品率は？」「深夜対応は？」など、隠れた付加価値を深掘りする。
    2.  `scenario_generator`使用: 発見した強みを言語化し、交渉時の「切り札トーク」としてシナリオに組み込む。
    3.  Value Proposition: 単なる値上げではなく、「高品質維持のための投資」であるというストーリーを構築。

#### CHECK 8: 法令違反（買いたたき）リスクのチェック
*   **目的**: 現在の取引が下請法違反の可能性があることを認識
*   **課題**: 違法な取引条件を「業界の常識」と思い込み、我慢している。
*   **ゴール**: 現在の取引が「下請法違反」の可能性があることを認識し、是正を求める根拠を持つ。
*   **AI支援**:
    1.  リスクチェック: 「支払サイトは60日以内か？」「手形割引料は？」「型保管料は？」など、チェックリストでリスク判定。
    2.  `search_knowledge_base`使用: 該当する違反事例と、公正取引委員会のガイドラインを提示。「これは法律違反です」と言える自信を持たせる。

#### CHECK 9: 必達目標額の決定（コスト影響最終試算）⭐最重要⭐
*   **目的**: 自社の生存に必要な「最低転嫁額」と「希望転嫁額」を明確化
*   **課題**: 交渉の着地点が見えず、相手の言い値で妥協してしまう。
*   **ゴール**: 自社の生存に必要な「最低転嫁額」と、目指すべき「希望転嫁額」を明確にする。
*   **AI支援**:
    1.  `analyze_cost_impact`使用: 全データを統合し、最終的な価格改定シミュレーションを実行。
    2.  戦略策定: 「松（15%）」「竹（10%）」「梅（5%）」の3つのラインを設定し、それぞれの撤退ラインを決める。
    3.  統合: 原材料費データと原価構造を統合し、数学的根拠で「この金額が必要」を証明。

---

### 🟠 §2 価格交渉実践編 (STEP 1〜5)
準備は整った。ここからは実際の行動（アクション）に移り、結果を勝ち取るフェーズ。

#### STEP 1: 外堀を埋める（業界・世論の空気作り）
*   **目的**: 「値上げは社会的な要請」という空気を作る
*   **ゴール**: 「値上げはうちだけのワガママではなく、社会的な要請である」という空気を作る。
*   **AI支援**:
    1.  `market_analysis`使用: 同業他社の値上げニュース、業界団体の「値上げのお願い」声明文を収集。
    2.  出力: これらを資料としてまとめ、「業界全体がそういう流れです」と伝えるための証拠セットを作成。

#### STEP 2: ターゲット選定と優先順位付け
*   **目的**: 勝率の高い相手から攻略し、実績を作る
*   **ゴール**: 全取引先に一斉にアタックするのではなく、勝率の高い相手から攻略し、実績を作る。
*   **AI支援**:
    1.  `company_research`使用: 取引先リストを分析。「パートナーシップ宣言あり」「業績好調」「取引依存度が低い（切りやすい）」相手をSランクに設定。
    2.  アドバイス: 最初の交渉相手として最適な「練習台（失注しても痛くない相手）」または「理解のある相手」を推奨。

#### STEP 3: 交渉の申し入れ（アポイントメント）
*   **目的**: 門前払いを回避し、決裁権者との正式な商談時間を確保
*   **ゴール**: 門前払いを回避し、決裁権者との正式な商談時間を確保する。
*   **AI支援**:
    1.  `document_generator`使用: 「価格改定のお願い（アポ打診用）」メール/書面を作成。
    2.  トーン調整: 相手との関係性に応じ、「低姿勢で相談」「事務的に通達」「窮状を訴える」などトーンを使い分ける。

#### STEP 4: 交渉本番（プレゼンテーション & クロージング）⭐最重要⭐
*   **目的**: 納得ずくで値上げを承諾させる
*   **ゴール**: 準備した資料とロジックを駆使し、納得ずくで値上げを承諾させる。
*   **AI支援**:
    1.  `document_generator`使用: 「根拠資料セット（グラフ、試算表、見積書）」を最終出力。
    2.  `scenario_generator`使用: 当日の交渉シナリオ（台本）を表示。想定問答集を手元に用意させる。
    3.  ロールプレイ訓練: AIが取引先役を演じ、「値上げは受け入れられない」「他社に切り替える」などの反論に対する対抗話法を練習。
    4.  リアルタイムサポート: 交渉直前のメンタルセットアップ、直後の振り返りと次の一手の助言。

#### STEP 5: アフターフォロー & 発注後の微調整
*   **目的**: 合意内容を確実に契約書に落とし込み、スポット案件での取りこぼしを防ぐ
*   **ゴール**: 合意内容を確実に契約書に落とし込み、なし崩し的な変更を防ぐ。また、スポット案件での取りこぼしを防ぐ。
*   **AI支援**:
    1.  `document_generator`使用: 合意内容を反映した「合意書」や「確定見積書」を即座に作成・送付。
    2.  アラート: スポット案件や仕様変更が発生した際、「それは当初見積もりに含まれていません」と即座にアラートを出し、追加請求をナビゲート。

---

## 🌐 5. 外部連携 & データレイヤー

### Web Search API
*   **用途**: 全ての外部データ取得に使用
*   **対象**:
    *   市場データ検索（企業物価指数、最低賃金）
    *   企業情報検索（決算短信、パートナーシップ宣言）
    *   ニュース検索（業界動向、IR情報）
    *   統計データ（e-Stat、厚労省）
*   **使用ツール**: `market_analysis`, `company_research`

### RAG Service (Knowledge Base)
*   **技術**: S3 + Vector Search
*   **登録データ**:
    *   下請法全文
    *   独占禁止法
    *   価格転嫁ハンドブック
    *   労務費転嫁指針
    *   公取委事例集
    *   原価計算モデル
*   **使用ツール**: `search_knowledge_base`, `analyze_cost_impact`

### S3 Storage
*   **用途**: セッション単位で管理
*   **保存データ**:
    *   生成グラフ画像（PNG/SVG）
    *   生成文書（PDF/Word/Excel）
    *   会話履歴（24時間自動削除）
    *   アップロードファイル（見積書等）
*   **使用ツール**: `document_generator`, `market_analysis`

---

## 💻 6. 技術スタック

### フロントエンド
*   **フレームワーク**: React
*   **UI**: チャットインターフェース

### バックエンド
*   **LLM**: Claude 4.5 Haiku（全モード共通）
*   **言語**: Python
*   **主要ライブラリ**:
    *   Web検索: Web Search API
    *   データ分析: Pandas, NumPy
    *   可視化: Matplotlib
    *   文書生成: Jinja2, python-docx, openpyxl
    *   RAG: Vector Search (S3ベース)

### インフラ
*   **ストレージ**: S3 (AWS)
*   **知識ベース**: S3 + Vector Search

---

## 📊 7. 成功指標 (KPI)

*   **モード移行率**: Mode 1からMode 2への移行率（目標: 30%以上）
*   **ステップ完了率**: CHECK 1-9を完了したユーザーの割合（目標: 70%以上）
*   **交渉成功報告率**: STEP 4（交渉本番）後の成功報告率（目標: 60%以上）
*   **ツール利用率**: 各専門ツールの起動回数・利用率
*   **ユーザー満足度**: NPS（Net Promoter Score）（目標: 50以上）

---

## 📝 8. 補足事項

### システムの特徴
*   ユーザーは対話を続けるだけで、LLMが会話内容に応じて最適なツールを直接選択・実行
*   専門知識不要で、プロフェッショナルレベルの交渉準備が可能
*   全てのアウトプットは「即座に使える成果物」として出力され、行動に直結
*   14ステップ（CHECK 1-9, STEP 1-5）は参考ガイドラインとして提供（順番の強制なし）

### 設計の根拠
*   中小企業庁「価格転嫁円滑化施策ハンドブック」に完全準拠
*   政府指針（労務費転嫁指針等）に基づく計算式を実装
*   下請法・独禁法の法的根拠を常に参照可能

### 今後の拡張可能性
*   他の経営課題（資金繰り、人材採用等）への専門モード追加
*   多言語対応の強化
*   業種特化型のカスタマイズ

---

**詳細なシステムアーキテクチャについては、[ARCHITECTURE.md](./ARCHITECTURE.md)を参照してください。**
**システム全体の可視化マップについては、[system-map.html](./system-map.html)を参照してください。**
