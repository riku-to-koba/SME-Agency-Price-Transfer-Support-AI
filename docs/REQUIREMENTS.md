# 中小企業よろず相談 & 価格転嫁支援AI - 要件定義書

## 📋 1. プロジェクト概要

### 目的
中小企業経営者のあらゆる悩みを受け止める「よろず相談」から始まり、課題が「価格転嫁」と特定された瞬間に、**最強の専門ツールを備えた「実行支援モード」**へとシームレスに移行するAIエージェントシステム。
単なる相談相手ではなく、**「共に戦う参謀」**として、データ収集、資料作成、交渉戦略の立案までを完遂させることを目的とする。

### コアコンセプト：2段階モード・エージェントシステム
ユーザーの対話深度と課題の緊急度に応じて、システムの振る舞いと使用可能なツールセットを動的に、かつ劇的に切り替える。

1.  **Mode 1: よろず相談モード (General Consultant)**
    *   **目的**: 経営課題の広範な探索と、真の課題（ボトルネック）の特定。
    *   **機能**: 傾聴、状況整理、メンタルケア、幅広い経営アドバイス（資金繰り、人材、販路拡大、事業承継など）。
    *   **Web検索機能**: **標準搭載**。最新の市場動向、業界ニュース、統計データなどをリアルタイムで取得可能。
    *   **スタンス**: 親身な聞き手、良き理解者。
    *   **モデル**: Claude 4.5 Haiku
    *   **ゴール**: 課題が「価格転嫁」にあるか否かの明確な切り分け。

2.  **Mode 2: 価格転嫁専門モード (Price Transfer Specialist)**
    *   **目的**: **価格交渉の完全勝利**と、適正利益の確保による経営基盤の強化。
    *   **機能**: 専門的市場分析、精緻なコスト計算、プロフェッショナルな法的文書作成、高精度な交渉シミュレーション。
    *   **動作の仕組み（重要）**:
        1. **ステップ自動判定**: 会話内容を分析し、現在どのステップ(CHECK 1-9 / STEP 1-5)にいるかをリアルタイムで判定
        2. **ツール自動選択**: 判定されたステップに応じて、最適なツール(6つの専門ツール)を自動的に選択・起動
        3. **シームレス実行**: ユーザーは対話を続けるだけで、裏側で専門ツールが連携動作し、最適な支援を提供
    *   **スタンス**: 頼れる軍師、冷徹な分析官、熱意ある交渉パートナー。
    *   **モデル**: Claude 4.5 Haiku
    *   **指針**: 中小企業庁のガイドラインおよび「Good Practice」を徹底的に遵守しつつ、**「勝てる」**論理を構築する。

---

## 🧠 2. 3層エージェントアーキテクチャ

本システムは**3つのエージェント**が協調動作する階層構造を採用する。

### 2.1 Orchestrator Agent（親エージェント・司令塔）

**役割:** 毎回の受け口として、モード判定と適切なエージェントへの振り分けを担当

**責務:**
- ユーザー入力を毎回受け取る（全リクエストの入り口）
- モード判定（Mode 1 or Mode 2）
- モード切り替え処理とユーザー承諾管理
- セッション状態の更新
- 適切な子エージェント（Mode 1 / Mode 2 Agent）への委譲

**判定方式:**
- **キーワードベース判定**: 「値上げ」「価格転嫁」「コスト増」「買いたたき」「下請法」等
- **軽量LLM推論**: キーワードで判定できない場合のみ、LLMに問い合わせ（最小トークン）
- **判定頻度**: 毎回（全リクエスト）

**モード切り替えフロー:**
1. Mode 1 → Mode 2: ユーザー承諾を求める
2. Mode 2 → Mode 1: 自動で切り替え（話題が変わった場合）
3. Mode 2の進捗データは保持され、再度Mode 2に戻った際に復元

**特性:** ステートレス（状態を持たない）。判定だけを行い、ビジネスロジックは持たない。

---

### 2.2 Mode 1 Agent（よろず相談エージェント）

**役割:** 一般的な経営相談に対応する汎用エージェント

**機能:**
- 傾聴、状況整理、メンタルケア
- 幅広い経営アドバイス（資金繰り、人材、販路拡大等）
- Web検索機能（標準搭載）

**使用ツール:**
- Web Search API（市場動向・ニュース検索）

**出力:**
- 価格転嫁キーワードを検知した場合、Orchestratorへ報告

---

### 2.3 Mode 2 Agent（価格転嫁専門エージェント）

**役割:** 価格転嫁に特化した専門エージェント。ステップ判定と進捗管理を担当。

**責務:**
- **ステップ判定**: 会話履歴全体から現在のステップ（CHECK 1-9 / STEP 1-5）を自動判定
- **進捗管理**: 完了したステップをセッションに記録し、継続的な支援を実現
- **ツール自動選択**: 判定したステップに応じて、最適なツール（6つの専門ツール）を自動選択・実行
- **依存関係チェック**: ステップ間の前提条件を考慮（例: CHECK 9にはCHECK 3が必要）

**ステップ判定方式:**
- **入力情報**: 会話履歴全体、直近のユーザー発言、完了済みステップ、過去のツール実行結果
- **判定ロジック**: LLM推論（Function Calling）により、文脈を理解して適切なステップを特定
- **出力**: ステップID（例: `CHECK_3`, `STEP_4`）
- **柔軟性**: ユーザーは順番通りでなく、自由にステップを行き来できる

**進捗管理:**
```python
session.mode2_progress = {
    "completed_steps": ["CHECK_2", "CHECK_3"],
    "current_step": "CHECK_6",
    "data": {
        "CHECK_2": {"graph_url": "...", "increase_rate": 35},
        "CHECK_3": {"cost_breakdown": {...}}
    }
}
```

**ツール自動選択の例:**
- ユーザー: 「取引先の財務状況を知りたい」
  - Mode 2 Agent: CHECK 6と判定 → `company_research`ツールを自動起動
- ユーザー: 「いくら値上げすればいいか分からない」
  - Mode 2 Agent: CHECK 9と判定 → `analyze_cost_impact`ツールを自動起動

**特性:** ステートフル（状態を保持）。進捗データをセッションに保存し、モード切り替え後も復元可能。

---

### 2.4 セッション管理と記憶の継続性

**セッション構造:**
```python
Session {
    session_id: str          # セッションID
    mode: str                # 現在のモード（"mode1" or "mode2"）
    history: List[Message]   # 全会話履歴（全モード共通）
    mode2_progress: dict     # Mode 2専用の進捗データ
}
```

**記憶の継続:**
- Orchestratorを毎回通っても、Mode 2の進捗（`mode2_progress`）は保持される
- Mode 1に切り替えても、Mode 2の進捗は消えない
- Mode 2に戻った際、前回の続きから再開可能

**実装パターン（段階的）:**
1. **プロトタイプ**: LLMコンテキストのみ（ストレージ不要）
2. **MVP**: インメモリストレージ（グローバル変数）
3. **本番環境**: ファイルシステム or Redis or DynamoDB

**ユーザー体験:**
```
ユーザー: 「原価計算したい」（CHECK 3）
→ Mode 2 Agent実行

ユーザー: 「人材採用で困ってて...」
→ Mode 1に切り替え

ユーザー: 「価格転嫁に戻りたい」
→ Mode 2に戻る
→ Mode 2 Agent: 「CHECK 3は完了してますね。次はCHECK 4はいかがですか？」
```

---

## 🛠️ 3. 6つの専門ツール詳細仕様（Mode 2専用）

本モードで使用可能なツールは、プロフェッショナルなコンサルタントが使用するレベルの高度な機能を、誰でも直感的に扱えるように設計されている。
これらのツールは単独でも強力だが、組み合わせることで「証拠収集→分析→戦略立案→資料作成→交渉実行」という一連のバリューチェーンを完全自動化する。

### ツール設計思想
*   **Zero Learning Curve**: 専門知識がなくても、対話だけで最適な分析・資料が手に入る。
*   **Evidence-Based**: すべての主張に「出典」と「計算根拠」を付与し、反論を許さない。
*   **Actionable Output**: 「参考になりました」で終わらせない。即座に使える成果物（ファイル、文書、スクリプト）を出力する。

### ① `market_analysis` (市場データ分析ツール)
*   **概要**: 「なんとなく上がった」という主観を排除し、**「誰もが否定できない客観的ファクト」**を提示する強力な武器。
*   **データソース**: Web Search APIを活用し、日本銀行（企業物価指数）、厚生労働省（地域別最低賃金、賃金構造基本統計調査）、経済産業省（エネルギー価格統計）、e-Stat（政府統計）、各種業界団体の公開統計データ、市況ニュースを取得。
*   **詳細機能**:
    *   **特定品目トレンド抽出**: 「ステンレス」「小麦」「段ボール」「軽油」など、ユーザーのビジネスに直結する品目の価格推移をピンポイントで抽出。
    *   **高解像度グラフ生成**: 交渉の場でそのまま提示可能な、視認性の高い推移グラフ（過去3〜5年分）を自動生成。上昇トレンドを一目で理解させる。
    *   **インフレ率算出**: 「2021年比で原材料費が1.45倍、エネルギー費が1.6倍」といった具体的な倍率数値を算出し、交渉の「数字的根拠」を固める。
    *   **業界比較分析**: 同業他社や関連業界の価格改定動向を横断的に収集し、「業界全体で値上げが進んでいる」という外堀を埋める証拠を提供。
    *   **予測モデル**: 過去のトレンドから、今後6ヶ月〜1年のコスト推移を予測し、「今交渉しないと更に厳しくなる」という緊迫感を演出。
    *   **カスタムレポート生成**: 分析結果を「エグゼクティブサマリー」形式で1ページにまとめ、経営層への説明資料として即座に使える形で出力。
*   **技術スタック**: Web Search API, Pandas, Matplotlib, NumPy
*   **使用タイミング**: CHECK 2, STEP 1

### ② `company_research` (取引先調査ツール)
*   **概要**: 相手（交渉相手）を丸裸にし、攻めるべき「隙」と「タイミング」を科学的に見極めるインテリジェンス・ツール。
*   **検索対象**: Web Search APIで最新ニュース、プレスリリース、IR情報（決算短信、有価証券報告書）、中期経営計画、パートナーシップ構築宣言、CSR方針、業界レポートを収集。
*   **詳細機能**:
    *   **パートナーシップ宣言確認**: 取引先が「パートナーシップ構築宣言」を出しているかを即座に特定。宣言企業であれば、「宣言内容（共存共栄）と矛盾しますよ」という最強のカードを切れる。
    *   **CSR・サステナビリティ方針分析**: 相手企業の「調達方針」や「サプライチェーン管理方針」を分析し、倫理的な側面から値上げを迫るロジックを構築。
    *   **財務状況分析**: 相手が増収増益基調か、内部留保が潤沢かを分析。「支払う能力がある」ことを見抜き、強気の交渉が可能か判定する。S/A/B/Cランクで優先順位付け。
    *   **経営陣プロファイリング**: 代表取締役や購買担当役員の経歴、過去の発言（インタビュー記事等）を収集し、「現場重視」「数字重視」などのタイプを推定。交渉時の訴求ポイントを最適化する。
    *   **競合他社との力関係分析**: 取引先にとって自社がどれほど重要なサプライヤーか（代替可能性）を推定し、交渉の強気度を調整。
    *   **過去の値上げ対応履歴**: 公開情報から、取引先が過去に他のサプライヤーからの値上げ要請にどう対応したかを調査。前例を探し出し、「前回は受け入れていますよね？」という論拠を作る。
    *   **タイミング・インテリジェンス**: 決算発表日、株主総会、大型受注発表などのイベントカレンダーを把握し、「相手が機嫌の良いタイミング」を狙い撃ちする。
*   **技術スタック**: Web Search API, LLM (情報抽出・財務分析)
*   **使用タイミング**: CHECK 6, STEP 2

### ③ `analyze_cost_impact` (コスト影響試算ツール)
*   **概要**: 自社の経営を守るために**「絶対に譲れないライン」**を数学的に算出する、本システムの心臓部。
*   **入力**: 売上高構成比、各原価項目（材料費、労務費、エネルギー費、外注費、経費）の現状と予測。
*   **詳細機能**:
    *   **損益分岐点シミュレーション**: 現状のまま推移した場合の「赤字転落時期」や「利益減少額」をシビアに試算し、ユーザーに行動を促す。
    *   **指針準拠フォーミュラ**: 「労務費の適切な転嫁のための価格交渉に関する指針」などの公的計算式を完全実装。法的に正当な計算ロジックを用いる。
    *   **3段階価格設定（松・竹・梅）**:
        *   **松（理想）**: 利益率改善も含めた満額回答プラン（例: 15%値上げ）。
        *   **竹（妥当）**: コスト上昇分をきっちり転嫁する現実的プラン（例: 10%値上げ）。
        *   **梅（防衛）**: 経営維持のための最低防衛ライン（例: 5%値上げ）。
    *   **ロジック解説生成**: なぜその金額になるのか、計算式と根拠を文章化し、相手方経理担当者を納得させる説明文を用意する。
    *   **製品別・取引先別の優先度マトリクス**: 複数製品・複数取引先がある場合、どの組み合わせから交渉すべきかを「利益インパクト × 交渉成功率」のマトリクスで可視化。
    *   **段階的値上げシナリオ**: 一度に大幅値上げが難しい場合、「今回5%、半年後に追加3%」といった段階的プランを自動生成。
    *   **What-If分析**: 「もし取引先Aが拒否したら？」「原材料費がさらに10%上がったら？」といった複数の未来シナリオを並行シミュレーション。
    *   **キャッシュフロー影響試算**: 値上げが実現した場合の月次キャッシュフロー改善額を算出し、「この交渉で年間○○万円の利益が守られます」と可視化。
    *   **競合価格ベンチマーク**: 同業他社の価格水準（公開情報から推定）と比較し、「業界水準から見ても妥当」という論拠を補強。
*   **技術スタック**: NumPy, Pandas, RAG (計算式参照), Excel出力
*   **使用タイミング**: CHECK 3, CHECK 9（最重要）

### ④ `scenario_generator` (交渉シナリオ生成・訓練ツール)
*   **概要**: 本番で失敗しないための「完璧な脚本」を用意し、AI相手の模擬戦で経験値を積むトレーニング・ツール。
*   **詳細機能**:
    *   **SWOTクロス分析**: 自社の「代替不可能性（強み）」と「取引依存度（弱み）」を分析し、強気を押すべきか、協調路線で行くべきかの戦略を決定。
    *   **タイミング最適化**: 相手の決算月、契約更新時期、人事異動のタイミングなどを考慮した、最も成功率の高い「交渉日時」を提案。
    *   **バーター条件生成**: 万が一価格転嫁が拒否された場合に備え、「支払サイト短縮」「発注ロット適正化」「有償支給化」など、実質的な利益確保のための代替案（プランB）を提示。
    *   **ハイレベル・ロールプレイ**:
        *   **ペルソナ設定**: 「高圧的な購買部長」「板挟みの担当者」「論理武装したインテリ担当」など、リアルな敵役を演じ分ける。
        *   **リアルタイムコーチング**: ユーザーの回答に対し、「今の言い方は弱気すぎます」「ここでは法律論を出しましょう」と即座に指導。
        *   **スコアリング**: 「論理性」「協調性」「精神的タフネス」を採点し、改善点をフィードバック。
    *   **想定問答集の自動生成**: 「予算がない」「他社はもっと安い」「今は時期が悪い」など、典型的な拒否理由に対する切り返しトークを、ユーザーの状況に合わせてカスタマイズ生成。
    *   **交渉フロー設計**: 「導入（関係構築）→ 問題提起 → 証拠提示 → 提案 → クロージング」という交渉の黄金フローに沿った台本を作成。
    *   **感情コントロール訓練**: ロールプレイ中にわざと挑発的な発言を投げかけ、ユーザーが冷静さを保てるかをテスト。感情的になった場合は即座に警告。
    *   **複数ラウンド・シミュレーション**: 「初回交渉で拒否された場合の2回目アプローチ」まで想定し、粘り強い交渉戦略を練習させる。
    *   **勝ちパターン・ライブラリ**: 過去の成功事例（架空または匿名化された実例）から、業種・状況別の「勝ちパターン」を検索・提示。
*   **技術スタック**: LLM (Multi-Agent), ロールプレイ評価エンジン
*   **使用タイミング**: CHECK 7, STEP 4（最重要）

### ⑤ `document_generator` (文書自動生成ツール)
*   **概要**: 交渉に必要な「武器（書類）」を、数秒で、弁護士監修レベルのクオリティで作成する。
*   **生成物一覧**:
    *   **価格交渉申入書**: 時候の挨拶から始まり、法的根拠、値上げの背景、切実な事情を盛り込んだ、相手が無視できない正式な依頼文。
    *   **コスト費目別見積書**: ハンドブック様式に完全準拠。材料費、加工費、管理費等を明確に分解し、透明性を担保した見積書。
    *   **価格改定説明資料（プレゼン資料）**: `market_analysis`のグラフや`analyze_cost_impact`の計算結果を美しくレイアウトした、そのまま配れる説明資料。
    *   **合意書**: 口頭合意を文書化し、継続的な適正価格を維持。
    *   **仕様変更合意書**: 追加業務が発生した際に、その場ですぐに取り交わせる簡易契約書。
*   **詳細機能**:
    *   **トーン＆マナー調整**: 相手との関係性（長年の取引先 vs 新規、対等 vs 下請け）に応じて、文体を「丁寧」「標準」「切実」「毅然」の4段階で調整。
    *   **法的文言の自動挿入**: 下請法や独占禁止法の関連条文を、文脈に応じて適切に引用・挿入し、法的正当性を強調。
    *   **多言語対応**: 海外取引先向けに、英語・中国語での文書生成も対応（機械翻訳ではなく、ビジネス文書として通用するレベル）。
    *   **バージョン管理**: 過去に生成した文書を履歴として保存し、「前回の申入書をベースに修正版を作る」といった反復作業を効率化。
    *   **電子署名対応**: 生成した文書にそのまま電子署名を付与できる形式（PDF/A）で出力し、法的証拠力を担保。
    *   **添付資料の自動統合**: グラフ、試算表、参考資料を1つのPDFパッケージにまとめ、「これ一つ送れば完結」という状態を実現。
*   **技術スタック**: Jinja2, python-docx, openpyxl, PDF生成ライブラリ
*   **使用タイミング**: 全ステップで活躍（CHECK 1, 4, 5, STEP 3, 4, 5など）

### ⑥ `search_knowledge_base` (法務知識検索ツール)
*   **概要**: 下請法、独占禁止法、各種ガイドラインを網羅した「ポケットの中の法務部」。
*   **知識ベース（RAG）**: S3 + Vector Search で、以下のデータを事前登録:
    *   下請代金支払遅延等防止法（下請法）全文
    *   独占禁止法 関連条文
    *   価格転嫁円滑化施策ハンドブック（中小企業庁）
    *   労務費の適切な転嫁のための価格交渉に関する指針
    *   公正取引委員会 勧告事例集
    *   原価計算の基礎（業種別モデル）
*   **詳細機能**:
    *   **違法性即時判定**: 「これって買いたたきじゃないですか？」という問いに対し、関連条文を引用して白黒判定。
    *   **対抗話法検索**: 「予算がない」「前例がない」といったよくある断り文句に対する、法的に正しい反論フレーズを検索・提示。
    *   **制度案内**: パートナーシップ構築宣言の登録方法や、価格転嫁を支援する公的助成金情報を案内。
    *   **判例・事例検索**: 公正取引委員会の勧告事例、中小企業庁の「Good Practice」事例集から、類似ケースを検索し、「こういう事例で認められています」という前例を提示。
    *   **Q&Aチャットボット**: 「支払サイトは何日まで許される？」「有償支給の適正価格は？」といった実務的な疑問に、条文と解説付きで即答。
    *   **リスクアラート**: ユーザーが入力した取引条件を自動スキャンし、「これは下請法違反の可能性があります」と警告。
    *   **通報・相談窓口案内**: 違法性が高い場合、公正取引委員会や下請かけこみ寺などの公的相談窓口への連絡方法を案内。
*   **技術スタック**: RAG (S3 + Vector Search), LLM (回答生成)
*   **使用タイミング**: CHECK 3, CHECK 8, 随時

---

## 📖 4. プロセス別完全プレイブック (Process-Tool Mapping)

各ステップにおいて、ユーザーは何をすべきか、AIはどう支援すべきかを極限まで具体化したアクションプラン。
システムは会話内容から現在のステップを自動判定し、最適なツールを自動選択・実行する。

### 🟢 §1 価格交渉準備編 (CHECK 1-9)
交渉のテーブルに着く前に、勝負の8割は決まっている。徹底的な準備で外堀を埋めるフェーズ。

#### CHECK 1: 取引条件・業務内容の完全可視化
*   **目的**: 契約の曖昧さを排除し、追加請求できる状態にする
*   **課題**: 口約束、曖昧な発注書、「一式」見積もりが横行し、どこまでが契約範囲かが不明確。これでは追加請求ができない。
*   **ゴール**: 契約のグレーゾーンを撤廃し、すべての業務をリスト化する。
*   **AI動作**:
    1.  現状ヒアリング: 「契約書はありますか？」「発注書と実作業に乖離はありませんか？」を徹底確認。
    2.  `document_generator`自動起動: 「業務フロー図」テンプレートを展開。ユーザーと共に業務の棚卸しを行い、サービス残業的なタスクをあぶり出す。
    3.  `document_generator`: 「見積チェックリスト」を作成し、次回からの受注時の必須確認事項を定める。

#### CHECK 2: 原材料費・労務費データの証拠化
*   **目的**: 「なんとなく上がった」を「客観的データ」に変換
*   **課題**: 「最近高い気がする」という感覚論では、交渉相手に鼻で笑われる。
*   **ゴール**: 公的統計データを味方につけ、反論不可能な事実を突きつける。
*   **AI動作**:
    1.  `market_analysis`自動起動: ユーザーの主要原材料（鉄、樹脂、食品等）を特定し、過去3年の価格推移データをWeb検索で取得。
    2.  `market_analysis`: 地域別最低賃金の推移データを取得し、労務費上昇の根拠とする。
    3.  視覚化: 上昇トレンドが一目でわかる「インパクト・グラフ」を作成し、ユーザーに提示。

#### CHECK 3: 精緻な原価計算の実施
*   **目的**: 製品1個あたりの正確なコスト構造を把握
*   **課題**: どんぶり勘定が染み付いており、製品1個あたりの正確なコスト構造が不明。
*   **ゴール**: 製品・サービス単位で「原価」と「利益」を1円単位で把握する。
*   **AI動作**:
    1.  `search_knowledge_base`自動起動: 業種に合わせた原価計算の基本モデル（簡易コース、詳細コース）を提示。
    2.  `analyze_cost_impact`自動起動: 対話形式で変動費（材料・外注）、固定費（人件費・家賃）を入力させ、配賦計算を実行。
    3.  分析: 採算割れしている製品（赤字製品）を特定し、優先交渉対象としてマークする。

#### CHECK 4: 戦略的単価表の作成
*   **目的**: 標準化された「自社定価」を持つ
*   **課題**: 案件ごとに都度見積もりを作っており、価格の整合性が取れていない。
*   **ゴール**: 誰に見せても恥ずかしくない、標準化された「自社定価」を持つ。
*   **AI動作**:
    1.  `document_generator`自動起動: 部品別、工程別、スキルレベル別（職人ランク等）の標準単価表フォーマットを提供。
    2.  最適化: CHECK 3の原価データに基づき、適正利益を乗せた「新・標準単価」を提案・策定。

#### CHECK 5: 「中身の見える」見積書フォーマットへの刷新
*   **目的**: コスト費目を明記し、価格転嫁の透明性を確保
*   **課題**: 「一式」見積もりは値上げ交渉の天敵。内訳が見えないと、どこが上がったか説明できない。
*   **ゴール**: コスト費目（材料費、加工費、配送費、管理費）を明記し、価格転嫁の透明性を確保する。
*   **AI動作**:
    1.  `document_generator`自動起動: 中小企業庁推奨の「コスト費目別見積書」テンプレートを出力。
    2.  ガイダンス: 既存の見積もりを新フォーマットに変換する作業をサポート。内訳の分解方法をアドバイス。

#### CHECK 6: 敵を知る（取引先の経営分析）
*   **目的**: 相手の「支払い能力」と「建前」を把握し、攻め筋を決める
*   **課題**: 相手の懐事情を知らずに交渉し、タイミングを誤る。または、相手の「嘘（儲かっていないふり）」を見抜けない。
*   **ゴール**: 相手の「支払い能力（実力）」と「建前（方針）」を把握し、攻め筋を決める。
*   **AI動作**:
    1.  `company_research`自動起動: 取引先の最新決算、ニュース、中期計画をWeb検索で調査。
    2.  分析: 「増収増益」「最高益更新」などのキーワードがあれば、強気交渉のサインとして通知。
    3.  チェック: 「パートナーシップ構築宣言」実施企業リストと照合。宣言企業なら、その公約を利用する戦略を立案。

#### CHECK 7: 自社の「代替不可能性」の言語化
*   **目的**: 「あなたじゃなきゃ困る」と思わせる強みを再定義
*   **課題**: 「他でも買える」と思われている。価格競争に巻き込まれている。
*   **ゴール**: 「あなたじゃなきゃ困る」と思わせる強み（短納期、品質、対応力）を再定義し、交渉カードにする。
*   **AI動作**:
    1.  深堀りインタビュー: 「他社が断る面倒な仕事を受けていませんか？」「不良品率は？」「深夜対応は？」など、隠れた付加価値を深掘りする。
    2.  `scenario_generator`自動起動: 発見した強みを言語化し、交渉時の「切り札トーク」としてシナリオに組み込む。
    3.  Value Proposition: 単なる値上げではなく、「高品質維持のための投資」であるというストーリーを構築。

#### CHECK 8: 法令違反（買いたたき）リスクのチェック
*   **目的**: 現在の取引が下請法違反の可能性があることを認識
*   **課題**: 違法な取引条件を「業界の常識」と思い込み、我慢している。
*   **ゴール**: 現在の取引が「下請法違反」の可能性があることを認識し、是正を求める根拠を持つ。
*   **AI動作**:
    1.  リスクチェック: 「支払サイトは60日以内か？」「手形割引料は？」「型保管料は？」など、チェックリストでリスク判定。
    2.  `search_knowledge_base`自動起動: 該当する違反事例と、公正取引委員会のガイドラインを提示。「これは法律違反です」と言える自信を持たせる。

#### CHECK 9: 必達目標額の決定（コスト影響最終試算）⭐最重要⭐
*   **目的**: 自社の生存に必要な「最低転嫁額」と「希望転嫁額」を明確化
*   **課題**: 交渉の着地点が見えず、相手の言い値で妥協してしまう。
*   **ゴール**: 自社の生存に必要な「最低転嫁額」と、目指すべき「希望転嫁額」を明確にする。
*   **AI動作**:
    1.  `analyze_cost_impact`自動起動: ここまでの全データを統合し、最終的な価格改定シミュレーションを実行。
    2.  戦略策定: 「松（15%）」「竹（10%）」「梅（5%）」の3つのラインを設定し、それぞれの撤退ラインを決める。
    3.  統合: CHECK 2のデータ（原材料費+20%）とCHECK 3の原価構造を統合し、数学的根拠で「この金額が必要」を証明。

---

### 🟠 §2 価格交渉実践編 (STEP 1〜5)
準備は整った。ここからは実際の行動（アクション）に移り、結果を勝ち取るフェーズ。

#### STEP 1: 外堀を埋める（業界・世論の空気作り）
*   **目的**: 「値上げは社会的な要請」という空気を作る
*   **ゴール**: 「値上げはうちだけのワガママではなく、社会的な要請である」という空気を作る。
*   **AI動作**:
    1.  `market_analysis`自動起動: 同業他社の値上げニュース、業界団体の「値上げのお願い」声明文を収集。
    2.  出力: これらを資料としてまとめ、「業界全体がそういう流れです」と伝えるための証拠セットを作成。

#### STEP 2: ターゲット選定と優先順位付け
*   **目的**: 勝率の高い相手から攻略し、実績を作る
*   **ゴール**: 全取引先に一斉にアタックするのではなく、勝率の高い相手から攻略し、実績を作る。
*   **AI動作**:
    1.  `company_research`自動起動: 取引先リストを分析。「パートナーシップ宣言あり」「業績好調」「取引依存度が低い（切りやすい）」相手をSランクに設定。
    2.  アドバイス: 最初の交渉相手として最適な「練習台（失注しても痛くない相手）」または「理解のある相手」を推奨。

#### STEP 3: 交渉の申し入れ（アポイントメント）
*   **目的**: 門前払いを回避し、決裁権者との正式な商談時間を確保
*   **ゴール**: 門前払いを回避し、決裁権者との正式な商談時間を確保する。
*   **AI動作**:
    1.  `document_generator`自動起動: 「価格改定のお願い（アポ打診用）」メール/書面を作成。
    2.  トーン調整: 相手との関係性に応じ、「低姿勢で相談」「事務的に通達」「窮状を訴える」などトーンを使い分ける。

#### STEP 4: 交渉本番（プレゼンテーション & クロージング）⭐最重要⭐
*   **目的**: 納得ずくで値上げを承諾させる
*   **ゴール**: 準備した資料とロジックを駆使し、納得ずくで値上げを承諾させる。
*   **AI動作**:
    1.  `document_generator`自動起動: 「根拠資料セット（グラフ、試算表、見積書）」を最終出力。
    2.  `scenario_generator`自動起動: 当日の交渉シナリオ（台本）を表示。想定問答集を手元に用意させる。
    3.  ロールプレイ訓練: AIが取引先役を演じ、「値上げは受け入れられない」「他社に切り替える」などの反論に対する対抗話法を練習。
    4.  リアルタイムサポート: 交渉直前のメンタルセットアップ、直後の振り返りと次の一手の助言。

#### STEP 5: アフターフォロー & 発注後の微調整
*   **目的**: 合意内容を確実に契約書に落とし込み、スポット案件での取りこぼしを防ぐ
*   **ゴール**: 合意内容を確実に契約書に落とし込み、なし崩し的な変更を防ぐ。また、スポット案件での取りこぼしを防ぐ。
*   **AI動作**:
    1.  `document_generator`自動起動: 合意内容を反映した「合意書」や「確定見積書」を即座に作成・送付。
    2.  アラート: スポット案件や仕様変更が発生した際、「それは当初見積もりに含まれていません」と即座にアラートを出し、追加請求をナビゲート。

---

## 🌐 5. 外部連携 & データレイヤー

### Web Search API
*   **用途**: 全ての外部データ取得に使用
*   **対象**:
    *   市場データ検索（企業物価指数、最低賃金）
    *   企業情報検索（決算短信、パートナーシップ宣言）
    *   ニュース検索（業界動向、IR情報）
    *   統計データ（e-Stat、厚労省）
*   **使用ツール**: `market_analysis`, `company_research`

### RAG Service (Knowledge Base)
*   **技術**: S3 + Vector Search
*   **登録データ**:
    *   下請法全文
    *   独占禁止法
    *   価格転嫁ハンドブック
    *   労務費転嫁指針
    *   公取委事例集
    *   原価計算モデル
*   **使用ツール**: `search_knowledge_base`, `analyze_cost_impact`

### S3 Storage
*   **用途**: セッション単位で管理
*   **保存データ**:
    *   生成グラフ画像（PNG/SVG）
    *   生成文書（PDF/Word/Excel）
    *   会話履歴（24時間自動削除）
    *   アップロードファイル（見積書等）
*   **使用ツール**: `document_generator`, `market_analysis`

---

## 💻 6. 技術スタック

### フロントエンド
*   **フレームワーク**: React
*   **UI**: チャットインターフェース

### バックエンド
*   **LLM**: Claude 4.5 Haiku（全モード共通）
*   **言語**: Python
*   **主要ライブラリ**:
    *   Web検索: Web Search API
    *   データ分析: Pandas, NumPy
    *   可視化: Matplotlib
    *   文書生成: Jinja2, python-docx, openpyxl
    *   RAG: Vector Search (S3ベース)

### インフラ
*   **ストレージ**: S3 (AWS)
*   **知識ベース**: S3 + Vector Search

---

## 📊 7. 成功指標 (KPI)

*   **モード移行率**: Mode 1からMode 2への移行率（目標: 30%以上）
*   **ステップ完了率**: CHECK 1-9を完了したユーザーの割合（目標: 70%以上）
*   **交渉成功報告率**: STEP 4（交渉本番）後の成功報告率（目標: 60%以上）
*   **ツール利用率**: 各専門ツールの起動回数・利用率
*   **ユーザー満足度**: NPS（Net Promoter Score）（目標: 50以上）

---

## 📝 8. 補足事項

### システムの特徴
*   ユーザーは対話を続けるだけで、システムが自動的に現在のステップを判定し、最適なツールを選択・実行
*   専門知識不要で、プロフェッショナルレベルの交渉準備が可能
*   全てのアウトプットは「即座に使える成果物」として出力され、行動に直結

### 設計の根拠
*   中小企業庁「価格転嫁円滑化施策ハンドブック」に完全準拠
*   政府指針（労務費転嫁指針等）に基づく計算式を実装
*   下請法・独禁法の法的根拠を常に参照可能

### 今後の拡張可能性
*   他の経営課題（資金繰り、人材採用等）への専門モード追加
*   多言語対応の強化
*   業種特化型のカスタマイズ

---

**詳細なシステムアーキテクチャについては、[ARCHITECTURE.md](./ARCHITECTURE.md)を参照してください。**
**システム全体の可視化マップについては、[system-map.html](./system-map.html)を参照してください。**
