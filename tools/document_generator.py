"""æ–‡æ›¸è‡ªå‹•ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆgenerate_documentï¼‰

äº¤æ¸‰ã«å¿…è¦ãªã€Œæ­¦å™¨ï¼ˆæ›¸é¡ï¼‰ã€ã‚’ã€æ•°ç§’ã§ã€ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªã‚¯ã‚ªãƒªãƒ†ã‚£ã§ä½œæˆã€‚
"""
import os
import uuid
from datetime import datetime
from typing import Optional, Dict, Any, List
from strands import tool


# æ–‡æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
TEMPLATES = {
    "request_letter": {
        "formal": """
æ‹å•“

æ™‚ä¸‹ã¾ã™ã¾ã™ã”æ¸…æ „ã®ã“ã¨ã¨ãŠæ…¶ã³ç”³ã—ä¸Šã’ã¾ã™ã€‚
å¹³ç´ ã¯æ ¼åˆ¥ã®ãŠå¼•ãç«‹ã¦ã‚’è³œã‚Šã€åšãå¾¡ç¤¼ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã•ã¦ã€ã“ã®ãŸã³å¼Šç¤¾ã§ã¯ã€æ˜¨ä»Šã®{cost_reason}ã‚’å—ã‘ã€èª ã«æç¸®ãªãŒã‚‰ä¾¡æ ¼æ”¹å®šã®ãŠé¡˜ã„ã‚’ç”³ã—ä¸Šã’ãŸãã€ã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚

ã€ä¾¡æ ¼æ”¹å®šã®èƒŒæ™¯ã€‘
{reason}

ã€æ”¹å®šå†…å®¹ã€‘
- ç¾è¡Œä¾¡æ ¼: {current_price}
- æ”¹å®šå¾Œä¾¡æ ¼: {new_price}
- æ”¹å®šç‡: {increase_rate}

ã€æ”¹å®šå®Ÿæ–½äºˆå®šæ—¥ã€‘
{effective_date}

å¼Šç¤¾ã¨ã„ãŸã—ã¾ã—ã¦ã‚‚ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠªåŠ›ã‚’é‡ã­ã¦ãŠã‚Šã¾ã™ãŒã€å“è³ªã‚’ç¶­æŒã—ãªãŒã‚‰å®‰å®šä¾›çµ¦ã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã€ä½•å’ã”ç†è§£ã¨ã”å”åŠ›ã‚’è³œã‚Šã¾ã™ã‚ˆã†ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã”ä¸æ˜ãªç‚¹ç­‰ã”ã–ã„ã¾ã—ãŸã‚‰ã€æ‹…å½“è€…ã¾ã§ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
å¼•ãç¶šãã®ã”æ„›é¡§ã‚’è³œã‚Šã¾ã™ã‚ˆã†ã€ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ•¬å…·
""",
        "friendly": """
{client_name}æ§˜

ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{company_name}ã®{contact_name}ã§ã™ã€‚

æ—¥é ƒã‚ˆã‚Šé•·å¹´ã®ãŠå–å¼•ã‚’ã„ãŸã ãã€å¿ƒã‚ˆã‚Šæ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã•ã¦ã€å¤§å¤‰æç¸®ã§ã¯ã”ã–ã„ã¾ã™ãŒã€ä¾¡æ ¼æ”¹å®šã«ã¤ã„ã¦ã”ç›¸è«‡ã•ã›ã¦ã„ãŸã ããŸãã€ã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚

ã€èƒŒæ™¯ã€‘
{reason}

ã€ã”ç›¸è«‡å†…å®¹ã€‘
- ç¾è¡Œ: {current_price}
- ã”ç›¸è«‡ä¾¡æ ¼: {new_price}ï¼ˆ{increase_rate}ã‚¢ãƒƒãƒ—ï¼‰

{client_name}æ§˜ã¨ã¯é•·ã„ãŠä»˜ãåˆã„ã‚’ã•ã›ã¦ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã®ã§ã€ã¾ãšã¯ã”ç›¸è«‡ã¨ã„ã†å½¢ã§ãŠè©±ã—ã•ã›ã¦ã„ãŸã ã‘ã‚Œã°ã¨å­˜ã˜ã¾ã™ã€‚

ã”éƒ½åˆã®ã‚ˆã„æ—¥æ™‚ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
""",
        "assertive": """
{client_name}æ§˜

{company_name}ã§ã”ã–ã„ã¾ã™ã€‚

ã“ã®ãŸã³ã€ä¾¡æ ¼æ”¹å®šã«ã¤ã„ã¦æ­£å¼ã«ãŠç”³ã—å…¥ã‚Œã„ãŸã—ã¾ã™ã€‚

ã€æ”¹å®šç†ç”±ã€‘
{reason}

ãªãŠã€å‚è€ƒã¾ã§ã«ç”³ã—æ·»ãˆã¾ã™ã¨ã€ä¸‹è«‹æ³•ã§ã¯ã€Œç™ºæ³¨è€…ãŒä¸€æ–¹çš„ã«ã€é€šå¸¸æ”¯æ‰•ã‚ã‚Œã‚‹å¯¾ä¾¡ã«æ¯”ã—ã¦è‘—ã—ãä½ã„ä¸‹è«‹ä»£é‡‘ã®é¡ã‚’å®šã‚ã‚‹ã“ã¨ã€ã¯è²·ã„ãŸãŸãã¨ã—ã¦ç¦æ­¢ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚

ã€æ”¹å®šå†…å®¹ã€‘
- ç¾è¡Œä¾¡æ ¼: {current_price}
- æ”¹å®šå¾Œä¾¡æ ¼: {new_price}
- æ”¹å®šç‡: {increase_rate}
- å®Ÿæ–½æ—¥: {effective_date}

è²´ç¤¾ã«ãŠã‹ã‚Œã¾ã—ã¦ã¯ã€é©æ­£ãªå–å¼•ã®è¦³ç‚¹ã‹ã‚‰ã”æ¤œè¨ã„ãŸã ãã¾ã™ã‚ˆã†ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã”å›ç­”ã¯{response_deadline}ã¾ã§ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
""",
        "urgent": """
{client_name}æ§˜

{company_name}ã§ã”ã–ã„ã¾ã™ã€‚

èª ã«æã‚Œå…¥ã‚Šã¾ã™ãŒã€ç·Šæ€¥ã®ãŠé¡˜ã„ãŒã”ã–ã„ã¾ã™ã€‚

ã€ç¾çŠ¶ã€‘
{reason}

ã“ã®ã¾ã¾ã§ã¯å¼Šç¤¾ã®çµŒå–¶ç¶™ç¶šãŒå›°é›£ãªçŠ¶æ³ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

ã€ãŠé¡˜ã„ã€‘
- ç¾è¡Œä¾¡æ ¼: {current_price}
- ã”ç›¸è«‡ä¾¡æ ¼: {new_price}ï¼ˆ{increase_rate}ã‚¢ãƒƒãƒ—ï¼‰

é•·å¹´ã®ãŠå–å¼•é–¢ä¿‚ã‚’ç¶­æŒã•ã›ã¦ã„ãŸã ããŸã‚ã«ã‚‚ã€ä½•å’ã”ç†è§£ã¨ã”å”åŠ›ã‚’è³œã‚Šã¾ã™ã‚ˆã†ã€åˆ‡ã«ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

æ—©æ€¥ã«ãŠæ‰“ã¡åˆã‚ã›ã®æ©Ÿä¼šã‚’ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚

ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚
"""
    },
    "quotation": """
å¾¡è¦‹ç©æ›¸

{client_name}å¾¡ä¸­

ä¸‹è¨˜ã®é€šã‚ŠãŠè¦‹ç©ã‚‚ã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚

â–  è¦‹ç©æ—¥: {date}
â–  è¦‹ç©ç•ªå·: {quote_number}
â–  æœ‰åŠ¹æœŸé™: {valid_until}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ãŠè¦‹ç©ã‚Šå†…å®¹ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{items}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å°è¨ˆ: {subtotal}
æ¶ˆè²»ç¨ï¼ˆ{tax_rate}%ï¼‰: {tax}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åˆè¨ˆ: {total}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€å‚™è€ƒã€‘
{notes}

{company_name}
{contact_info}
""",
    "cost_breakdown": """
åŸä¾¡å†…è¨³æ›¸

â–  å¯¾è±¡è£½å“/ã‚µãƒ¼ãƒ“ã‚¹: {product_name}
â–  ä½œæˆæ—¥: {date}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ã‚³ã‚¹ãƒˆæ§‹æˆã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{cost_items}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŸä¾¡åˆè¨ˆ: {total_cost}
ç›®æ¨™åˆ©ç›Šï¼ˆ{profit_margin}%ï¼‰: {target_profit}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é©æ­£è²©å£²ä¾¡æ ¼: {selling_price}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€ã‚³ã‚¹ãƒˆå¤‰å‹•è¦å› ã€‘
{cost_factors}

ã€è£œè¶³ã€‘
{notes}
""",
    "agreement": """
åˆæ„æ›¸

{company_name}ï¼ˆä»¥ä¸‹ã€Œç”²ã€ã¨ã„ã†ï¼‰ã¨{client_name}ï¼ˆä»¥ä¸‹ã€Œä¹™ã€ã¨ã„ã†ï¼‰ã¯ã€
ä»¥ä¸‹ã®å†…å®¹ã«ã¤ã„ã¦åˆæ„ã™ã‚‹ã€‚

â–  åˆæ„æ—¥: {date}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åˆæ„å†…å®¹ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç¬¬1æ¡ï¼ˆä¾¡æ ¼æ”¹å®šï¼‰
{price_terms}

ç¬¬2æ¡ï¼ˆé©ç”¨é–‹å§‹æ—¥ï¼‰
æœ¬åˆæ„ã«åŸºã¥ãä¾¡æ ¼æ”¹å®šã¯ã€{effective_date}ã‚ˆã‚Šé©ç”¨ã™ã‚‹ã€‚

ç¬¬3æ¡ï¼ˆãã®ä»–ï¼‰
{other_terms}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¸Šè¨˜å†…å®¹ã«åˆæ„ã—ãŸã“ã¨ã‚’è¨¼ã™ã‚‹ãŸã‚ã€æœ¬æ›¸2é€šã‚’ä½œæˆã—ã€
ç”²ä¹™è¨˜åæŠ¼å°ã®ä¸Šã€å„1é€šã‚’ä¿æœ‰ã™ã‚‹ã€‚

ç”²: {company_name}
   ä»£è¡¨è€…: ___________________  å°

ä¹™: {client_name}
   ä»£è¡¨è€…: ___________________  å°
""",
    "negotiation_materials": """
ä¾¡æ ¼æ”¹å®šã®ã”èª¬æ˜

{company_name}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ä¾¡æ ¼æ”¹å®šã®èƒŒæ™¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{background}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2. ã‚³ã‚¹ãƒˆä¸Šæ˜‡ã®è©³ç´°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{cost_details}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
3. ä¾¡æ ¼æ”¹å®šã®ã”ææ¡ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{proposal}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
4. å¼Šç¤¾ã®å–ã‚Šçµ„ã¿
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{our_efforts}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
5. ä»Šå¾Œã«ã¤ã„ã¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{future_plans}

ä½•å’ã”ç†è§£ã¨ã”å”åŠ›ã‚’è³œã‚Šã¾ã™ã‚ˆã†ã€ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

ãŠå•ã„åˆã‚ã›å…ˆ: {contact_info}
"""
}


def _format_document(template: str, data: Dict[str, Any]) -> str:
    """ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’åŸ‹ã‚è¾¼ã‚“ã§æ–‡æ›¸ã‚’ç”Ÿæˆ"""
    result = template
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    defaults = {
        "date": datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥"),
        "effective_date": "ã”ç›¸è«‡ã®ä¸Šæ±ºå®š",
        "response_deadline": "2é€±é–“ä»¥å†…",
        "valid_until": (datetime.now().replace(day=1) + __import__('datetime').timedelta(days=32)).replace(day=1).strftime("%Yå¹´%mæœˆ%dæ—¥"),
        "quote_number": f"Q-{datetime.now().strftime('%Y%m%d')}-{uuid.uuid4().hex[:4].upper()}",
        "tax_rate": "10",
        "cost_reason": "åŸææ–™è²»ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼è²»ã®é«˜é¨°",
        "company_name": "ï¼ˆè²´ç¤¾åï¼‰",
        "client_name": "ï¼ˆãŠå–å¼•å…ˆåï¼‰",
        "contact_name": "ï¼ˆæ‹…å½“è€…åï¼‰",
        "contact_info": "ï¼ˆé€£çµ¡å…ˆï¼‰",
    }
    
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒãƒ¼ã‚¸
    merged_data = {**defaults, **data}
    
    # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
    for key, value in merged_data.items():
        placeholder = "{" + key + "}"
        if placeholder in result:
            result = result.replace(placeholder, str(value) if value else "")
    
    return result


def _save_document(content: str, document_type: str, title: str) -> str:
    """æ–‡æ›¸ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜"""
    # ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
    docs_dir = os.path.join(os.path.dirname(os.path.dirname(__file__)), "documents")
    os.makedirs(docs_dir, exist_ok=True)
    
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚º
    safe_title = "".join(c for c in title if c.isalnum() or c in " -_").strip()[:30]
    if not safe_title:
        safe_title = document_type
    
    # ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
    filename = f"{document_type}_{safe_title}_{uuid.uuid4().hex[:8]}.txt"
    filepath = os.path.join(docs_dir, filename)
    
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)
    
    return filepath


@tool
def generate_document(
    document_type: str,
    data: dict,
    tone: str = "formal"
) -> str:
    """ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

    Args:
        document_type: æ–‡æ›¸ã‚¿ã‚¤ãƒ—
            - "quotation": ã‚³ã‚¹ãƒˆè²»ç›®åˆ¥è¦‹ç©æ›¸
            - "request_letter": ä¾¡æ ¼äº¤æ¸‰ç”³å…¥æ›¸
            - "negotiation_materials": ä¾¡æ ¼æ”¹å®šèª¬æ˜è³‡æ–™
            - "agreement": åˆæ„æ›¸
            - "cost_breakdown": åŸä¾¡å†…è¨³æ›¸
        data: æ–‡æ›¸ã«åŸ‹ã‚è¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ï¼ˆä¼šç¤¾åã€é‡‘é¡ã€ç†ç”±ç­‰ï¼‰
            - client_name: å–å¼•å…ˆå
            - company_name: è‡ªç¤¾å
            - current_price: ç¾è¡Œä¾¡æ ¼
            - new_price: æ”¹å®šå¾Œä¾¡æ ¼
            - increase_rate: æ”¹å®šç‡
            - reason: æ”¹å®šç†ç”±
            - items: è¦‹ç©é …ç›®ï¼ˆè¦‹ç©æ›¸ã®å ´åˆï¼‰
            - ãã®ä»–ã€æ–‡æ›¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ‡ãƒ¼ã‚¿
        tone: æ–‡æ›¸ã®ãƒˆãƒ¼ãƒ³ï¼ˆrequest_letterã®ã¿æœ‰åŠ¹ï¼‰
            - "formal": æ­£å¼ãªæ–‡æ›¸
            - "friendly": å”èª¿çš„ãªæ–‡ä½“
            - "assertive": æ¯…ç„¶ã¨ã—ãŸæ–‡ä½“
            - "urgent": åˆ‡å®Ÿãªæ–‡ä½“

    Returns:
        str: ç”Ÿæˆã•ã‚ŒãŸæ–‡æ›¸ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ä¿å­˜å…ˆ
    
    ä½¿ç”¨ä¾‹:
    - ä¾¡æ ¼äº¤æ¸‰ã®ç”³å…¥æ›¸: document_type="request_letter", tone="friendly"
    - ã‚³ã‚¹ãƒˆè²»ç›®åˆ¥è¦‹ç©æ›¸: document_type="quotation"
    - äº¤æ¸‰èª¬æ˜è³‡æ–™: document_type="negotiation_materials"
    """
    try:
        print(f"\n{'='*60}")
        print(f"ğŸ“„ [generate_document] æ–‡æ›¸ç”Ÿæˆé–‹å§‹")
        print(f"   ã‚¿ã‚¤ãƒ—: {document_type}")
        print(f"   ãƒˆãƒ¼ãƒ³: {tone}")
        print(f"{'='*60}\n")
        
        # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
        if document_type == "request_letter":
            templates = TEMPLATES.get("request_letter", {})
            template = templates.get(tone, templates.get("formal", ""))
        else:
            template = TEMPLATES.get(document_type, "")
        
        if not template:
            return f"âŒ ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„æ–‡æ›¸ã‚¿ã‚¤ãƒ—ã§ã™: {document_type}\n\nå¯¾å¿œã‚¿ã‚¤ãƒ—: quotation, request_letter, negotiation_materials, agreement, cost_breakdown"
        
        # æ–‡æ›¸ã‚’ç”Ÿæˆ
        content = _format_document(template, data)
        
        # ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ±ºå®š
        title_map = {
            "quotation": "è¦‹ç©æ›¸",
            "request_letter": "ä¾¡æ ¼æ”¹å®šç”³å…¥æ›¸",
            "negotiation_materials": "ä¾¡æ ¼æ”¹å®šèª¬æ˜è³‡æ–™",
            "agreement": "åˆæ„æ›¸",
            "cost_breakdown": "åŸä¾¡å†…è¨³æ›¸",
        }
        title = title_map.get(document_type, document_type)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
        filepath = _save_document(content, document_type, title)
        
        # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰
        preview = content[:500] + "..." if len(content) > 500 else content
        
        print(f"âœ… æ–‡æ›¸ç”ŸæˆæˆåŠŸ: {filepath}")
        
        return f"""âœ… æ–‡æ›¸ã‚’ç”Ÿæˆã—ã¾ã—ãŸ

**æ–‡æ›¸ã‚¿ã‚¤ãƒ—**: {title}
**ãƒˆãƒ¼ãƒ³**: {tone}
**ä¿å­˜å…ˆ**: {os.path.basename(filepath)}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{preview}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ–‡æ›¸ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦å†…å®¹ã‚’ç·¨é›†ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚"""
        
    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}")
        import traceback
        traceback.print_exc()
        return f"âŒ æ–‡æ›¸ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"

